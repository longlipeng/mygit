<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="COUPONSETTLEMENT">


	<!-- 查询是否有批次在同账期内执行结算 -->
	<select id="judgeWetherSettleIng" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select count(*) from tb_settle_batch
		where status=#settleState# and (#startDate# between start_date and end_date
		or #endDate# between start_date and end_date)
	</select>

	<!-- 批量更新消费订单批次 -->
	<update id="batchSettlement" parameterClass="java.util.HashMap">
	<![CDATA[
		update
		CP_CONSUME_ORDER
		set
		SETTLE_BATCH_ID=#settleBatchId#,UPDATED_TIME=#updatedTime#
		where FATHER_ENTITY_ID=#fatherEntityId# and
		substr(TRADE_TIME,1,8)>=#beginDate# and substr(TRADE_TIME,1,8)<=#endDate# and SETTLE_BATCH_ID IS NULL
		]]>
	</update>

	<!-- 统计金额 -->
	<select id="settleByMcht" parameterClass="java.lang.Long"
		resultClass="com.allinfinance.svc.coupon.dto.SettleStatisticDto">
		select mcht_entity_id as mchtNo,sum(
		case type
		when '1' then
		AMOUNT
		when '-1' then -AMOUNT
		end
		) as settleMoney from
		CP_CONSUME_ORDER 
		where
		settle_batch_id=#settleBatchId#
		group by mcht_entity_id
		
	</select>
	
	<select id="querySettlementByPage" resultClass="java.util.HashMap"
	remapResults="true" parameterClass="com.allinfinance.svc.coupon.dto.SettlementQueryDto">
		<include refid="Commons.prefixSql" />
			select 
			s.ID as "id",
			s.SETTLE_NO as "settleNo",
			s.SETTLE_BATCH_ID as "settleBatchId",
			s.mcht_entity_id as "mchtCode",
			m.MERCHANT_NAME as "mchtName",
			s.BEGIN_DATE as "beginDate",
			s.END_DATE as "endDate",
			s.TOTAL_AMOUNT as "totalAmount",
			s.COMMISSION_AMOUNT as "commissionAmount",
			s.RECEIVED_INVOINCE_AMOUNT as "receivedInvoinceAmount",
			s.WAIT_IVC_AMOUNT as "waitIvcAmount",
			s.STATUS as "status",
			s.CREATED_TIME "createdTime",
			s.UPDATED_TIME as "updatedTime",
			s.SEND_STATUS as "sendStatus",
			s.INVOICE_SEND_STATUS as "invoiceSendStatus"
			from TB_SETTLEMENT s
			left join TB_MERCHANT m
			on s.mcht_entity_id=m.ENTITY_ID and s.father_entity_id=m.father_entity_id
			where s.father_entity_id=#fatherEntityId#
			<isNotEmpty prepend="and" property="mchtCode">
				s.mcht_entity_id=#mchtCode#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="sendStatus">
				s.SEND_STATUS=#sendStatus#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="invoiceSendStatus">
				s.INVOICE_SEND_STATUS=#invoiceSendStatus#
			</isNotEmpty>
		<include refid="Commons.suffixSql" />
	</select>
	
	<select id="querySettlementTrade" resultClass="java.util.HashMap" remapResults="true" parameterClass="java.util.HashMap">
select o.mcht_entity_id,
       nvl(c.customer_name, '') as customer_name,
       d.item_order_no,
       decode(d.direction,
              '1',
              (dec(d.amount, 31, 2) / 100),
              '-1',
              '-' || (dec(d.amount, 31, 2) / 100)) as amount,
       d.trade_time,
       decode(d.direction, '1', '消费', '-1', '退货') as direction
  from cp_consume_order o
  left join tb_customer c
    on o.mcht_entity_id = c.entity_id
   and o.father_entity_id = c.father_entity_id
  left join cp_trade_item_dealed d
    on o.id = d.ref_order_id
 where o.settle_batch_id = #batchId#
   and o.mcht_entity_id = #mchtId#
   and d.ref_order_type = '3'
   and o.father_entity_id = '5101'
	</select>
	
</sqlMap>