<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ACCTYPE_CONTRACT" >

  <!-- 选择服务对应的合同，结果集中不含卡BIN，通过distinct关键字获取结果-->
  <select id="selectAccTypeByConsumerContraId" resultClass="com.allinfinance.univer.consumercontract.dto.AccTypeContractDTO" parameterClass="java.lang.String" >
    select distinct ACCTYPE_CONTRACT_ID "acctypeContractId", CONSUMER_CONTRACT_ID "consumerContractId", RULE_NO "ruleNo", ACCTYPE_ID "acctypeId", CONTRACT_BUYER "contractBuyer"
    from TB_ACCTYPE_CONTRACT t1
    where CONSUMER_CONTRACT_ID = #consumerContractId:VARCHAR#
  </select>
  
  <!-- 选择服务对应的合同，结果集中不含卡BIN，通过distinct关键字获取结果-->
  <select id="selectAccTypeByContractBuyer" resultClass="com.huateng.framework.ibatis.model.AcctypeContract" parameterClass="java.lang.String" >
    select distinct ACCTYPE_CONTRACT_ID "acctypeContractId", CONSUMER_CONTRACT_ID "consumerContractId", RULE_NO "ruleNo", ACCTYPE_ID "acctypeId", CONTRACT_BUYER "contractBuyer"
    from TB_ACCTYPE_CONTRACT t1
    where CONTRACT_BUYER = #contractBuyer:VARCHAR#
  </select>

  <!-- 选择满足含有指定服务、且不含有指定卡BIN的合同，结果集中不含卡BIN-->
  <select id="selectAccTypeContractByCardBin" resultClass="com.allinfinance.univer.consumercontract.dto.AccTypeContractDTO" parameterClass="java.util.HashMap" >
	select distinct t1.CONSUMER_CONTRACT_ID "consumerContractId",
                t1.ACCTYPE_CONTRACT_ID  "acctypeContractId",
                t1.RULE_NO              "ruleNo",
                t1.ACCTYPE_ID           "acctypeId",
                t1.CONTRACT_BUYER       "contractBuyer"
  from TB_ACCTYPE_CONTRACT t1, tb_consumer_contract t3
	where t1.consumer_contract_id= t3.consumer_contract_id 
		and t3.contract_type = 1
		and ACCTYPE_ID in
		<iterate property="acctypeIds" conjunction="," close=")" open="(" > 
			#acctypeIds[]# 
		</iterate>	
	and not exists
	(
		select *
		from TB_ACCTYPE_CONTRACT  t2 
		where CARD_BIN = #cardBin:VARCHAR# 
		and ACCTYPE_ID in
			<iterate property="acctypeIds" conjunction="," close=")" open="(" > 
				#acctypeIds[]# 
			</iterate>		 
		and
		t1.CONSUMER_CONTRACT_ID =t2.CONSUMER_CONTRACT_ID  
		and t1.ACCTYPE_CONTRACT_ID =t2.ACCTYPE_CONTRACT_ID
		and t1.RULE_NO=t2.RULE_NO
		and t1.ACCTYPE_ID=t2.ACCTYPE_ID
		and t1.CONTRACT_BUYER=t2.CONTRACT_BUYER
	)
  </select>
      
</sqlMap>