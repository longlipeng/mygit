<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CARD_INVALID_QUERY" >
	<select id="query" resultClass="java.util.HashMap"
		remapResults="true" parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderQueryDTO">
		<include refid="Commons.prefixSql" />
  		select
		t1.order_id as "orderId",
		t1.first_entity_id as  "entityId",
		COALESCE(t2.seller_name,t4.issuer_name) as "entityName",
		t1.card_quantity as "cardQuantity",
		t1.real_card_quantity as "realCardQuantity",
		to_date(t1.create_time,'yyyy-MM-dd hh24:mi:ss') as "createTime",
		t3.user_name as  "createUser"
		from   
		tb_sell_order t1 join
		tb_ent_user	t3 on t3.user_id = t1.create_user left outer join
		tb_seller t2 on t1.first_entity_id = t2.entity_id left outer join
		tb_issuer t4 on t1.first_entity_id = t4.entity_id
		where  t1.order_type = '10000007' and t1.data_state = '1'
		<dynamic>
			<isNotEmpty prepend="and" property="orderId" >
				t1.ORDER_ID=#orderId:varchar#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="entityId" >
				t1.FIRST_ENTITY_ID in (
				SELECT I.ENTITY_ID  
				FROM  TB_SELLER I 
				WHERE  I.DATA_STATE='1' and
      	        (I.ENTITY_ID =#entityId:varchar# or I.FATHER_ENTITY_ID =#entityId:varchar# or 
      	      	 I.FATHER_ENTITY_ID in(SELECT I.ENTITY_ID  
      	       						FROM  TB_SELLER I 
 		                            WHERE  I.DATA_STATE='1'
 		                            and I.FATHER_ENTITY_ID =#entityId:varchar#))
				)
			</isNotEmpty>
			<isNotEmpty prepend="and" property="createUserName" >
				UPPER(t3.USER_NAME) like UPPER('%'||#createUserName:VARCHAR#||'%')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="orderDateStart" >
				to_date(T1.ORDER_DATE,'YYYY-MM-DD') &gt;= to_date(#orderDateStart:VARCHAR#,'YYYY-MM-DD')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="orderDateEnd" >
				to_date(T1.ORDER_DATE,'YYYY-MM-DD') &lt;= to_date(#orderDateEnd:VARCHAR#,'YYYY-MM-DD')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="cardNo">
				T1.ORDER_ID in (select order_id from TB_SELL_ORDER_CARD_LIST
	                    where card_no=#cardNo#)
			</isNotEmpty>
		</dynamic>
		<include refid="Commons.suffixSql" />
  </select>
  <select id="view" resultClass="com.allinfinance.univer.seller.order.dto.SellOrderDTO"
		remapResults="true" parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderQueryDTO">
  		select
		t1.order_id as "orderId",
		t1.first_entity_id as  "firstEntityId",
		COALESCE(t2.seller_name,t4.issuer_name) as "firstEntityName",
		t1.card_quantity as "cardQuantity",
		t1.real_card_quantity as "realCardQuantity",
		to_date(t1.create_time,'yyyy-MM-dd hh24:mi:ss') as "createTime",
		t3.user_name as  "createUser",
		t5.product_id as "productId",
		t5.product_name as "productName",
		t1.memo as "memo"
		from   
		tb_sell_order t1 left outer join
		tb_product t5  on t1.PRODUCT_ID = t5.PRODUCT_ID join
		tb_ent_user	t3 on t3.user_id = t1.create_user left outer join
		tb_seller t2 on t1.first_entity_id = t2.entity_id left outer join
		tb_issuer t4 on t1.first_entity_id = t4.entity_id
		where  t1.order_type = '10000007' and t1.data_state = '1' and t1.order_id = #orderId:VARCHAR# 
  </select>
  <select id="viewcardlist" resultClass="java.util.HashMap"
		remapResults="true" parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderQueryDTO">
		<include refid="Commons.prefixSql" />
  		select
		t1.order_id as "orderId",
		t2.card_no as "cardNo",
		t3.user_name as  "createUser",
		t1.create_user as "createId",
        t4.product_name as "productName"
		from   
		tb_sell_order t1 join
		tb_ent_user t3 on t3.user_id = t1.create_user join
		tb_sell_order_card_list t2 on t1.order_id = t2.order_id left outer join
        tb_product t4  on t1.PRODUCT_ID = t4.PRODUCT_ID
		where  t1.order_type = '10000007' and t1.data_state = '1' and t1.order_id = #orderId:VARCHAR#
		<include refid="Commons.suffixSql" />
  </select>
</sqlMap>