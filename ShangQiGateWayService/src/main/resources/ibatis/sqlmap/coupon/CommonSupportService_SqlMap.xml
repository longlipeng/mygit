<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CommonSupportService">

	<typeAlias alias="TradeItemTempDto" type="com.allinfinance.svc.coupon.dto.TradeItemTempDto" />

	<select id="selectGroupByBatchNo" resultClass="TradeItemTempDto"
		parameterClass="java.util.Map">
		<![CDATA[
			SELECT COUPON_NO as couponNo,MCHT_CODE as mchtCode, 
			SUM(AMOUNT) AS amount, MIN(TRADE_TIME) AS tradeTime
			FROM CP_TRADE_ITEM_TEMP 
            WHERE BATCH_ID = #batchNo#
			GROUP BY COUPON_NO,MCHT_CODE
		 ]]>
	</select>

	<select id="selectByBatchNo" resultClass="TradeItemTempDto"
		parameterClass="java.util.Map">
		<![CDATA[
			SELECT COUPON_NO as couponNo,MCHT_CODE as mchtCode,ITEM_ORDER_NO as itemOrderNo,
			AMOUNT as amount,TRADE_TIME AS tradeTime
			FROM CP_TRADE_ITEM_TEMP WHERE BATCH_ID=#batchNo# 
		 ]]>
	</select>

	<select id="countTrade" resultClass="TradeItemTempDto"
		parameterClass="java.util.HashMap">
		<![CDATA[
			select min(t.id) as minId,count(t.id) as count from CP_TRADE_ITEM_TEMP t 
			where t.TRADE_TYPE=#tradeType#
			and t.DIRECTION=#direction#
			and ((t.status='0') 
			 	or ((t.status='2' or t.status='1') and t.UPDATED_TIME<#spaceTime#)) 
		]]>
	</select>

	<update id="updateBatch" parameterClass="java.util.HashMap">
		<![CDATA[
			update CP_TRADE_ITEM_TEMP T set T.BATCH_ID=#batchNo#, T.COUNTER=T.COUNTER+1, T.STATUS='2'
			where t.TRADE_TYPE=#tradeType#
			and t.DIRECTION=#direction#
			and ((t.status='0') 
			 	or ((t.status='2' or t.status='1') and t.UPDATED_TIME<#spaceTime#)) 
		]]>
	</update>

	<update id="updateBatchPage" parameterClass="java.util.HashMap">
		<![CDATA[
			update CP_TRADE_ITEM_TEMP T set T.BATCH_ID=#batchNo#, T.COUNTER=T.COUNTER+1, T.STATUS='2'
			where t.TRADE_TYPE=#tradeType#
			and t.DIRECTION=#direction#
			and ((t.status='0') 
			 	or ((t.status='2' or t.status='1') and t.UPDATED_TIME<#spaceTime#)) 
			and id >= #minId#
			and id <= #maxId#
		]]>
	</update>


</sqlMap>