<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CARDHOLDER" >
<select id="selectCardholdersByDTO" parameterClass="com.allinfinance.univer.seller.cardholder.dto.CardholderQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
    select
        T1.CARDHOLDER_ID as "cardholderId",
        T1.MEMBER_ID as "memberId",
        T1.FIRST_NAME as "firstName",
        T1.EXTERNAL_ID as "externalId",
        T1.CARDHOLDER_MOBILE as "cardholderMobile",
        T1.CARDHOLDER_SEGMENT as "cardholderSegment",
        T1.CARDHOLDER_STATE as "cardholderState",
        T1.DEPARTMENT_ID as "departmentId",
        T2.CUSTOMER_NAME as "customerName",
        T3.DEPARTMENT_NAME as "departmentName"
    from
        TB_CARDHOLDER T1 left join TB_ENTITY_DEPARTMENT T3 on T1.DEPARTMENT_ID = T3.DEPARTMENT_ID,
        TB_CUSTOMER T2    
    where
        T1.ENTITY_ID = T2.ENTITY_ID
        and T1.DATA_STATE = '1'
        and T2.DATA_STATE = '1' 
    <dynamic>
      <isNotEmpty prepend="and" property="defaultEntityId">
        T2.FATHER_ENTITY_ID = #defaultEntityId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="entityId">
        T1.ENTITY_ID = #entityId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="customerName">
        T2.CUSTOMER_NAME like '%'||#customerName:VARCHAR#||'%'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="externalId">
        T1.EXTERNAL_ID = #externalId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderId">
        T1.CARDHOLDER_ID = #cardholderId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="firstName">
        T1.FIRST_NAME like '%'||#firstName:VARCHAR#||'%'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderMobile">
        T1.CARDHOLDER_MOBILE = #cardholderMobile:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderSegment">
        T1.CARDHOLDER_SEGMENT = #cardholderSegment:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderState">
        T1.CARDHOLDER_STATE = #cardholderState:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardNo">
        T1.CARDHOLDER_ID in (
                     SELECT 
      cardList.Cardholder_Id
     from TB_SELL_ORDER_CARD_LIST cardList,tb_sell_order orde
      where 
      orde.order_id=cardList.Order_Id
       and orde.order_type !='10000003'
  		and cardList.data_state='1'
  		and cardList.card_no  is not null 
      and cardList.Card_No=#cardNo:VARCHAR#
        )
      </isNotEmpty>
    </dynamic>
    <include refid="Commons.suffixSql"/>
  </select>
<!--  
 <select id="selectCardholdersWithOrderListByDTO" parameterClass="com.huateng.univer.seller.cardholder.dto.CardholderQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
        select
            T1.CARDHOLDER_ID as "cardholderId",
            T1.CARDHOLDER_NAME as "cardholderName",
            T1.EXTERNAL_ID as "externalId",
            T2.CUSTOMER_NAME as "customerName",
            T1.MOBILE as "mobile",
            T1.SEGMENT as "segment",
            T1.STATE as "state",
            T1.DEPARTMENT_ID as "departmentId",
            T3.DEPARTMENT_NAME as "departmentName"
        from
            TB_ENT_CARDHOLDER T1,
            TB_ENT_CUSTOMER T2,
            TB_ENT_DEPARTMENT T3
        where
            T1.CUSTOMER_ID = T2.CUSTOMER_ID
            and T1.DATA_STATE = 1
            and T2.DATA_STATE = 1
            and T1.DEPARTMENT_ID = T3.DEPARTMENT_ID(+)
            and T1.CARDHOLDER_ID not in (select CARDHOLDER_ID from TB_ENT_ORDER_LIST
                                             where ORDER_ID = #orderId:VARCHAR# and DATA_STATE = 1)
        <dynamic>
          <isNotEmpty prepend="and" property="customerId">
            T1.CUSTOMER_ID = #customerId:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="customerName">
            T2.CUSTOMER_NAME like '%'||#customerName:VARCHAR#||'%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="externalId">
            T1.EXTERNAL_ID = #externalId:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="cardholderId">
            T1.CARDHOLDER_ID = #cardholderId:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="cardholderName">
            T1.CARDHOLDER_NAME like '%'||#cardholderName:VARCHAR#||'%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="mobile">
            T1.MOBILE = #mobile:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="segment">
            T1.SEGMENT = #segment:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="departmentId">
            T1.DEPARTMENT_ID = #departmentId:VARCHAR#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="state">
            T1.STATE = #state:VARCHAR#
          </isNotEmpty>
        </dynamic>
    <include refid="Commons.suffixSql"/>
  </select>
  -->
  <select id="isExistCustomerByCardholderDTO" parameterClass="com.allinfinance.univer.seller.cardholder.dto.CardholderDTO" resultClass="java.lang.Integer">

        select 
        	count(*) 
        from 
            TB_CARDHOLDER T0,
            TB_CARDHOLDER_CARDLIST T1
        where 
            T0.CARDHOLDER_ID = T1.CARDHOLDER_ID
        and 
        	T1.CARDHOLDER_ID = #cardholderId:VARCHAR#
        and 
        	T1.PRODUCT_ID not in(
          select 
          		distinct t2.product_id  
          from 
          		TB_SELL_PROD_CONTRACT t2
          where t2.sell_contract_id in (
               select 
               		t3.sell_contract_id 
               from 
               		tb_sell_contract t3 
               where 
               		t3.contract_buyer = #entityId:VARCHAR#
               and  t3.EXPIRY_DATE &gt;=SYSDATE
               and  t3.DATA_STATE = '1'
          )
        )
        
  </select>
<select id="selectCardholders" parameterClass="com.allinfinance.univer.seller.cardholder.dto.CardholderQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
    select   
        T1.CARDHOLDER_ID as "cardholderId",
        T1.MEMBER_ID as "memberId",
        T1.FIRST_NAME as "firstName",
        T1.ID_TYPE as "idType",
        T1.ID_NO as "idNo",
        T1.EXTERNAL_ID as "externalId",
        T1.CARDHOLDER_MOBILE as "cardholderMobile",
        T1.CARDHOLDER_SEGMENT as "cardholderSegment",
        T1.CARDHOLDER_STATE as "cardholderState",
        T1.DEPARTMENT_ID as "departmentId"
    from
        TB_CARDHOLDER T1
    where 1=1 
    <dynamic>
      <isNotEmpty prepend="and" property="entityId">
        T1.ENTITY_ID = #entityId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="externalId">
        T1.EXTERNAL_ID = #externalId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderId">
        T1.CARDHOLDER_ID = #cardholderId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="firstName">
        T1.FIRST_NAME like '%'||#firstName:VARCHAR#||'%'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderMobile">
        T1.CARDHOLDER_MOBILE = #cardholderMobile:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderSegment">
        T1.CARDHOLDER_SEGMENT = #cardholderSegment:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardholderState">
        T1.CARDHOLDER_STATE = #cardholderState:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="cardNo">
        T1.CARDHOLDER_ID in (
            SELECT 
      cardList.Cardholder_Id
      from  TB_SELL_ORDER_CARD_LIST cardList,tb_sell_order orde
      where 
      orde.order_id=cardList.Order_Id
       and orde.order_type !='10000003'
  		and cardList.data_state='1'
  		and cardList.card_no  is not null 
      and cardList.Card_No=#cardNo:VARCHAR#
        )
      </isNotEmpty>
    </dynamic>
    <include refid="Commons.suffixSql"/>
  </select>
</sqlMap>