<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="CONSUMER_CONTRACT">
<resultMap id="merchantByconsumer" class="com.allinfinance.univer.consumer.merchant.dto.MerchantDTO" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Sun Sep 26 15:56:13 CST 2010.
    -->
    <result column="ENTITY_ID" property="entityId" jdbcType="VARCHAR" />
    <result column="MERCHANT_NAME" property="merchantName" jdbcType="VARCHAR" />   
  </resultMap>
  
  <select id="selectContract" parameterClass="com.allinfinance.univer.consumercontract.dto.ConsumerContractQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
    select
        T1.CONSUMER_CONTRACT_ID as "consumerContractId",
        T1.CONTRACT_BUYER as "merchantId",
        t2.consumer_name as "merchantName",
        to_char(to_date(decode(trim(T1.CONTRACT_START_DATE),'',null,T1.CONTRACT_START_DATE),'yyyymmdd'),'yyyy-mm-dd') as "startDate",
        to_char(to_date(decode(trim(T1.CONTRACT_END_DATE),'',null,T1.CONTRACT_END_DATE),'yyyymmdd'),'yyyy-mm-dd') as "endDate",
        T1.rule_no as "ruleNo",
        t3.rule_name as "ruleName"
    from
        TB_CONSUMER_CONTRACT T1,
        TB_CONSUMER t2,
        TB_SETTLE_PERIOD_RULE t3
    where
        T1.CONTRACT_BUYER=t2.entity_id
        and T1.rule_no=t3.rule_no
        and T1.CONTRACT_SELLER = #contractSeller:VARCHAR#
        AND T1.DATA_STATE = '1'
        AND T2.DATA_STATE = '1'
        AND T1.CONTRACT_TYPE ='1'
    <dynamic>
      <isNotEmpty prepend="and" property="consumerContractId">
        T1.CONSUMER_CONTRACT_ID = #consumerContractId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="contractBuyer">
        T1.CONTRACT_BUYER= #contractBuyer:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="merchantName">
         UPPER(T2.consumer_name) like UPPER('%'||#merchantName:VARCHAR#||'%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="state">
        <isEqual property="state" compareValue="0">
            (T1.CONTRACT_END_DATE is not Null AND T1.CONTRACT_END_DATE &lt; to_char(sysdate,'yyyymmdd'))      
        </isEqual>
        <isEqual property="state" compareValue="1">
        	((T1.CONTRACT_END_DATE &gt;=  to_char(sysdate,'yyyymmdd')
        	OR T1.CONTRACT_END_DATE is NULL) AND T1.CONTRACT_START_DATE &lt;= to_char(sysdate,'yyyymmdd'))      
        </isEqual>
        <isEqual property="state" compareValue="2">
            T1.CONTRACT_START_DATE &gt; to_char(sysdate,'yyyymmdd')    
        </isEqual>
      </isNotEmpty>
    </dynamic>
    <include refid="Commons.suffixSql"/>
  </select>
  <select id="previewSettleInit" parameterClass="java.lang.String" resultMap="merchantByconsumer">
  select distinct t3.entity_id , t3.merchant_name 
  from tb_consumer_contract t1,tb_consumer t2 ,tb_merchant t3
   where t1.contract_seller=t2.entity_id and t1.contract_buyer=t3.entity_id
   and t2.entity_Id=#consumerId#
  </select>
  <!-- by youyong 添加下面一个新的语句
  <select id="selectById" parameterClass="java.lang.String" resultClass="com.huateng.univer.consumercontract.dto.ConsumerContractDTO" remapResults="true">
   select  T1.CONSUMER_CONTRACT_ID as "consumerContractId",
        T1.CONTRACT_BUYER as "merchantId",
        to_char(to_date(decode(trim(T1.CONTRACT_START_DATE),'',null,T1.CONTRACT_START_DATE),'yyyymmdd'),'yyyy-mm-dd') as "contractStartDate",
        to_char(to_date(decode(trim(T1.CONTRACT_END_DATE),'',null,T1.CONTRACT_END_DATE),'yyyymmdd'),'yyyy-mm-dd') as "contractEndDate",
        T1.rule_no as "ruleNo",
        t3.rule_name as "ruleName",
        decode(T1.CLEAR_TP,'1','汇总结算','2','逐笔结算') as "clearTp",
        t4.merchant_name as "merchantName",
        t4.merchant_code as "merchantCode"
    from TB_CONSUMER_CONTRACT T1 left join
        TB_CONSUMER t2 on T1.CONTRACT_BUYER=t2.entity_id left join 
        TB_SETTLE_PERIOD_RULE t3 on T1.rule_no=t3.rule_no left join
        TB_MERCHANT t4 on T1.CONTRACT_BUYER=t4.entity_id
    where  
	   T1.Contract_Buyer = #entityId#
	   and  (select sysdate from dual) >= to_date(T1.CONTRACT_START_DATE,'yyyymmdd')
	    and((select sysdate from dual) &lt;= to_date(T1.CONTRACT_end_DATE,'yyyymmdd')or T1.CONTRACT_end_DATE is null)
	   
  </select>
  by youyong end-->
   <select id="selectById" parameterClass="java.lang.String" resultClass="com.allinfinance.univer.consumercontract.dto.ConsumerContractDTO" remapResults="true">
   select  T1.CONSUMER_CONTRACT_ID as "consumerContractId",
        T1.CONTRACT_BUYER as "merchantId",
        to_char(to_date(decode(trim(T1.CONTRACT_START_DATE),'',null,T1.CONTRACT_START_DATE),'yyyymmdd'),'yyyy-mm-dd') as "contractStartDate",
        to_char(to_date(decode(trim(T1.CONTRACT_END_DATE),'',null,T1.CONTRACT_END_DATE),'yyyymmdd'),'yyyy-mm-dd') as "contractEndDate",
        T1.rule_no as "ruleNo",
        t3.rule_name as "ruleName",
        decode(T1.CLEAR_TP,'1','汇总结算','2','逐笔结算') as "clearTp",
        t4.merchant_name as "merchantName",
        t4.merchant_code as "merchantCode"
    from TB_CONSUMER_CONTRACT T1 left join
        TB_CONSUMER t2 on T1.CONTRACT_BUYER=t2.entity_id left join 
        TB_SETTLE_PERIOD_RULE t3 on T1.rule_no=t3.rule_no left join
        TB_MERCHANT t4 on T1.CONTRACT_BUYER=t4.entity_id
    where  
	   T1.Contract_Buyer = #entityId#
	   and  (select sysdate from SYSIBM.SYSDUMMY1) >= to_date(T1.CONTRACT_START_DATE,'yyyymmdd')
	    and((select sysdate from SYSIBM.SYSDUMMY1) &lt;= to_date(T1.CONTRACT_end_DATE,'yyyymmdd')or T1.CONTRACT_end_DATE is null)
	   
  </select>
</sqlMap>