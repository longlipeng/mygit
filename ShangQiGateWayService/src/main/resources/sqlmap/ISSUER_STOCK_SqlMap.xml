<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ISSUER_STOCK" >
  
  <select id="selectDTO" resultClass="java.util.HashMap" parameterClass="com.huateng.accor.issurestock.IssuerStockQueryDTO" >
	<include refid="Commons.prefixSql"/>
	    SELECT T1.CARD_LAYOUT_ID as "cardLayoutId",
	           T2.CARD_NAME as "cardName",
	           T1.FACE_VALUE_TYPE  as "faceValueType",
	           T1.FACE_VALUE/100 as "faceValue", 
	           T1.CARD_VALID_DATE as "cardValidDate",
	           COUNT(*) as "countRecord"
		FROM TB_ENT_ISSUER_STOCK T1,
			 TB_ENT_CARD_LAYOUT T2
		WHERE  
				T1.DATA_STATE='1' 
		 AND    T1.CARD_STOCK_STATE=2    
	     AND 	T1.CARD_LAYOUT_ID = T2.CARD_LAYOUT_ID
	     AND 	T1.ISSUER_ID = #issuerId:DECIMAL#
         AND    T1.PRODUCT_ID = #productId:DECIMAL#
       GROUP BY T1.CARD_LAYOUT_ID,
				 T2.CARD_NAME,
				 T1.FACE_VALUE_TYPE ,
				 T1.FACE_VALUE,
				 T1.CARD_VALID_DATE
    <include refid="Commons.suffixSql"/>
  </select>
  <select id="selectDistributeCard" resultClass="com.huateng.accorecard.stock.dto.StockCardMisDTO" 
  parameterClass="com.huateng.accorecard.stock.dto.StockCardMisDTO" >
    select * from (
  	select  stock.card_no as cardNo,
	stock.face_value_type as faceValueType,
	stock.face_value as faceValue,
	substr(stock.card_no,1,6) as cardPin,
	stock.product_id as productId,
	rank()   over(order   by  stock.card_no)   rk,
	row_number() over(order by stock.card_no) rn
	from tb_ent_issuer_stock stock 
	where stock.data_state='1'
	and stock.card_stock_state=2
	
	<dynamic>
	

		<isNotNull prepend="and" property="faceValueType">
       			 stock.face_value_type = #faceValueType:DECIMAL#
      	</isNotNull>
      	<isNotNull prepend="and" property="faceValue">
       			 stock.face_value = #faceValue:DECIMAL#
      	</isNotNull>
      	<isNotNull prepend="and" property="issuerId">
       			 stock.issuer_Id = #issuerId:DECIMAL#
      	</isNotNull>
      	<isNotNull prepend="and" property="productId">
       			 stock.product_Id = #productId:DECIMAL#
      	</isNotNull>
      	<isNotEmpty prepend="and" property="cardPin">
       			 substr(stock.card_no,1,6) = #cardPin:VARCHAR#
      	</isNotEmpty>
	</dynamic>  )   where  <![CDATA[ rk>=1  and 
			rn<=#cardNum:DECIMAL# ]]>
  </select>
  <select id="selectTakeCheckCard" resultClass="com.huateng.accorecard.stock.dto.StockCardMisDTO" 
  parameterClass="com.huateng.accorecard.stock.dto.StockCardMisDTO" >
  	select  count(t.card_no) as cardNum,
  	t.face_value_type as faceValueType,
  	t.face_value as faceValue,
  	t.trunk as trunk
	from tb_ent_issuer_stock t 
	where t.data_state='1'
	and t.card_stock_state=20
	<dynamic>
		<isNotEmpty prepend="and" property="trunk">
       			 t.trunk = #trunk:VARCHAR#
      	</isNotEmpty>
	</dynamic>
	group by t.face_value_type,t.face_value,t.trunk
  </select>
</sqlMap>