<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="BATCH_OPERATION" >
    <select id="inqueryOrder" parameterClass="com.huateng.accor.orderbatchoperation.dto.BatchOperationQueryDTO" resultClass="java.util.HashMap" remapResults="true">
        <include refid="Commons.prefixSql" />
        select
            T1.ORDER_ID as "orderId",
            T1.CUSTOMER_ID as "customerId",
            T1.ORDER_TYPE as "orderType",
            T1.ORDER_DATE as "orderDate",
            T1.ISSUER_ID as "issuerId",
            T1.CREATE_USER as "createUser",
            T1.ORDER_STATE as "orderState",
            T2.CUSTOMER_NAME as "customerName",
            T3.USER_NAME AS "userName",
            T4.ISSUER_NAME AS "issuerName"
        from
            TB_ENT_CUSTOMER_ORDER T1,
            TB_ENT_CUSTOMER T2,
            TB_ENT_USER T3,
            TB_ENT_ISSUER T4
        where
            T1.DATA_STATE='1'
            and T1.CUSTOMER_ID = T2.CUSTOMER_ID(+)
            and T1.CREATE_USER = T3.USER_ID(+)
            and T1.ISSUER_ID = T4.ISSUER_ID(+)
            <dynamic>
                <isNotNull prepend="and" property="defaultIssuerId">
                    T1.ISSUER_ID = #defaultIssuerId:DECIMAL#
                </isNotNull>
                <isNotEmpty prepend="and" property="customerName">
                    T2.CUSTOMER_NAME like '%'||#customerName:VARCHAR#||'%'
                </isNotEmpty>
                <isNotNull prepend="and" property="orderState">
                    T1.ORDER_STATE = #orderState:DECIMAL#
                </isNotNull>
                <isNotNull prepend="and" property="customerId">
                    T1.CUSTOMER_ID = #customerId:DECIMAL#
                </isNotNull>
                <isNotNull prepend="and" property="orderId">
                    T1.ORDER_ID = #orderId:DECIMAL#
                </isNotNull>
                <isNotNull prepend="and" property="orderType">
                    T1.ORDER_TYPE = #orderType:DECIMAL#
                </isNotNull>
                <isNull prepend="and" property="orderType">
                    T1.ORDER_TYPE in
                    <iterate property="orderTypes" conjunction="," open="(" close=")" >
                        #orderTypes[]#
                    </iterate>
                </isNull>
                <isNotNull prepend="and" property="createUser">
                    T1.CREATE_USER = #createUser:DECIMAL#
                </isNotNull>
                <!-- 整批停用录入查询订单（订单整批停用表无数据） -->
                <isEqual property="operateType" compareValue="1" prepend="and">
                    (
                        select
                            count(*)
                        from
                            TB_ENT_ORDER_CEASE T5
                        where
                            T5.ORDER_ID = T1.ORDER_ID
                            and T5.DATA_STATE = '1'
                    ) = 0
                </isEqual>
                <!-- 整批停用确定查询订单（订单整批停用表操作状态：录入） -->
                <isEqual property="operateType" compareValue="2" prepend="and">
                    ((
                        select
                            count(*)
                        from
                            TB_ENT_ORDER_CEASE T5
                        where
                            T5.ORDER_ID = T1.ORDER_ID
                            and T5.OPERATE_STATE = 1
                            and T5.DATA_STATE = '1'
                    ) > 0
                    and (
                        select
                            count(*)
                        from
                            TB_ENT_ORDER_CEASE T5
                        where
                            T5.ORDER_ID = T1.ORDER_ID
                            and T5.OPERATE_STATE = 2
                            and T5.DATA_STATE = '1'
                    ) = 0)
                </isEqual>
                <!-- 整批挂失查询订单（订单整批挂失表操作状态：挂失&&操作类型：挂失） -->
                <isEqual property="operateType" compareValue="3" prepend="and">
                    (
                        select
                            count(*)
                        from
                            TB_ENT_ORDER_BLOCK T5
                        where
                            T5.ORDER_ID = T1.ORDER_ID
                            and T5.OPERATE_STATE = '1'
                            and T5.OPERATE_TYPE = '1'
                            and T5.DATA_STATE = '1'
                    ) = 0
                </isEqual>
                <!-- 整批解挂查询订单（订单整批挂失表操作状态：挂失&&操作类型：挂失） -->
                <isEqual property="operateType" compareValue="4" prepend="and">
                    (
                        select
                            count(*)
                        from
                            TB_ENT_ORDER_BLOCK T5
                        where
                            T5.ORDER_ID = T1.ORDER_ID
                            and T5.OPERATE_STATE = '1'
                            and T5.OPERATE_TYPE = '1'
                            and T5.DATA_STATE = '1'
                    ) > 0
                </isEqual>
            </dynamic>
        <include refid="Commons.suffixSql" />
    </select>
    <insert id="insertOrderCease" parameterClass="com.huateng.accor.ibatis.model.OrderCease">
        insert into TB_ENT_ORDER_CEASE (
            ORDER_CEASE_ID,
            ORDER_ID,
            OPERATE_TYPE,
            CEASE_MEMO,
            OPERATE_STATE,
            CEASE_AMOUNT,
            ORDER_CARD_AMOUNT,
            CREATE_USER,
            CREATE_TIME,
            MODIFY_USER,
            MODIFY_TIME,
            DATA_STATE)
        values (
            #orderCeaseId:DECIMAL#,
            #orderId:DECIMAL#,
            #operateType:DECIMAL#,
            #ceaseMemo:VARCHAR#,
            #operateState:DECIMAL#,
            <dynamic>
                <isEqual property="operateType" compareValue="1">
                    (
                        select
                            sum(T3.ACC_BAL)
                        from
                            TB_CARD_INFO T1,
                            TB_REL_CARD_ACCOUNT T2,
                            TB_ACCOUNT_INFO T3,
                            TB_ENT_ORDER_CARD_LIST T4
                        where
                            T1.CARD_NO = T4.CARD_NO
                            and T1.CARD_NO = T2.CARD_NO
                            and T2.ACCOUNT_NO = T3.ACCOUNT_NO
                            and T2.ACC_TYPE = T3.ACC_TYPE
                            and T4.ORDER_ID = #orderId:DECIMAL#
                    ),
                    (
                        select
                            sum(T1.FACE_VALUE)
                        from
                            TB_ENT_ORDER_CARD_LIST T1
                        where
                            T1.ORDER_ID = #orderId:DECIMAL#
                    ),
                </isEqual>
                <isEqual property="operateType" compareValue="2">
                    #ceaseAmount:DECIMAL#,
                    #orderCardAmount:DECIMAL#,
                </isEqual>
            </dynamic>
            #createUser:DECIMAL#,
            #createTime#,
            #modifyUser:DECIMAL#,
            #modifyTime#,
            #dataState:DECIMAL#)
    </insert>
    <select id="selectCardInfoByOrderId" parameterClass="java.lang.Long" resultClass="com.huateng.accor.ibatis.model.CardInfo">
        select
            T1.CARD_NO as "cardNo"
        from
            TB_CARD_INFO T1,
            TB_ENT_ORDER_CARD_LIST T2
        where
            T1.CARD_NO = T2.CARD_NO
            and T2.ORDER_ID = #orderId:DECIMAL#
    </select>
</sqlMap>