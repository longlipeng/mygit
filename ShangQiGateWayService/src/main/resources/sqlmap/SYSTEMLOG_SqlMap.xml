<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="SYSTEMLOG">
  <select id="selectSystemLogByDTO" parameterClass="com.allinfinance.univer.system.syslog.SystemLogQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
    select
    	T1.LOG_ID as "logId",
        T3.CONSTCODE_NAME as "txnName",
        T1.TXN_CODE       as  "txnCode",
        decode(T1.SUCCESS_FLAG,'1','成功','失败') as "successFlag",
        VU.USER_NAME as "operationUser",
        to_char(to_date(T1.OPERATION_TIME,'YYYY-MM-DD HH24MISS'),'YYYY-MM-DD  HH24:MI:SS')  as "operationTime"
    from
     	TB_SYSTEM_LOG T1 left join
     	(
     		select T2.USER_ID as "USER_ID",
     		T2.USER_NAME as "USER_NAME",
     		T2.ENTITY_ID as "ENTITY_ID"
     		from  TB_ENT_USER T2
     		where T2.ENTITY_ID = #defaultEntityId:varchar#
     	) VU on T1.OPERATION_USER=VU.USER_ID left join
     	TB_TXN_CODE T3 on T1.TXN_CODE=T3.ID
    <dynamic prepend="where" >
     		<isNotEmpty prepend="and" property="logId">
       			 T1.LOG_ID = #logId:DECIMAL#
      		</isNotEmpty>
      		<isNotEmpty prepend="and" property="operationUser">
       			 UPPER(VU.USER_NAME) like UPPER('%'||#operationUser:VARCHAR#||'%')
      		</isNotEmpty>
      		<isNotEmpty prepend="and" property="txnCode">
       			 T1.TXN_CODE like '%'||#txnCode:VARCHAR#||'%'
      		</isNotEmpty>
      		<isNotNull prepend="and" property="successFlag">
      			 T1.SUCCESS_FLAG = #successFlag:DECIMAL#
      		</isNotNull>
      		<isNotNull prepend="and" property="operationTime">
      			 T1.OPERATION_TIME like '%'||to_char(#operationTime:DATE#,'yyyyMMdd')||'%'
      		</isNotNull>
      		<isNotEmpty prepend="and" property="txnName">
      			 T3.CONSTCODE_NAME like '%'||#txnName:VARCHAR#||'%'
      		</isNotEmpty>
    	</dynamic>
    <include refid="Commons.suffixSql"/>
  </select>
</sqlMap>