<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="card_invalid">
	<select id="card_invalid" resultClass="com.allinfinance.univer.report.dto.CardInvalidReportDTO"
		parameterClass="com.allinfinance.univer.report.dto.CardInvalidReportDTO">
		select
		t4.seller_name as "entityName",
		t2.card_no as "cardNo",
		t3.user_name as "operator",
		to_date(t1.create_time,'yyyy-MM-dd hh24:mi:ss') as "invalidDate",
		COALESCE(t1.memo,'') as "memo"
		from   
		tb_sell_order t1 join
		tb_ent_user t3 on t3.user_id = t1.create_user join
		tb_sell_order_card_list t2 on t1.order_id = t2.order_id join
		tb_seller t4 on t1.first_entity_id = t4.entity_id
		where  t1.order_type = '10000007' and t1.data_state = '1'
		<dynamic>
			<isNotEmpty prepend="and" property="entityId" >
				t1.FIRST_ENTITY_ID in (
				SELECT I.ENTITY_ID  
				FROM  TB_SELLER I 
				WHERE  I.DATA_STATE=1 and
      	        (I.ENTITY_ID =#entityId:varchar# or I.FATHER_ENTITY_ID =#entityId:varchar# or 
      	      	 I.FATHER_ENTITY_ID in(SELECT I.ENTITY_ID  
      	       						FROM  TB_SELLER I 
 		                            WHERE  I.DATA_STATE=1
 		                            and I.FATHER_ENTITY_ID =#entityId:varchar#))
				)
			</isNotEmpty>
			<isNotEmpty prepend="and" property="startDate" >
				to_date(t1.ORDER_DATE,'YYYY-MM-DD') &gt;= to_date(#startDate:VARCHAR#,'YYYY-MM-DD')
			</isNotEmpty>
			<isNotEmpty prepend="and" property="endDate" >
				to_date(t1.ORDER_DATE,'YYYY-MM-DD') &lt;= to_date(#endDate:VARCHAR#,'YYYY-MM-DD')
			</isNotEmpty>
		</dynamic>
		order by to_date(t1.create_time,'yyyy-MM-dd hh24:mi:ss'),t1.order_id
	</select>
</sqlMap>