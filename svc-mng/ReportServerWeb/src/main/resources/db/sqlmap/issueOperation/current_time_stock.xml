<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="current_time_stock">
	<select id="current_time_stock" resultClass="com.allinfinance.univer.report.dto.CurrentTimeStockDTO"
			parameterClass="com.allinfinance.univer.report.dto.CurrentTimeStockDTO">
	select
	t3.PRODUCT_ID,
	t3.PRODUCT_NAME as "productName",
	t4.DICT_NAME as "onymousStat",
	t5.DICT_NAME as "productType",
	t6.DICT_NAME as "faceValueType",
	decode(t1.FACE_VALUE,null,0,t1.FACE_VALUE)/100  as "faceValue",
	t2.STOCKVALUE as "stockValue"
	from TB_PRODUCT t3 
    left join
    (select
	distinct*
	from
   (select
	PRODUCT_ID,
	FACE_VALUE_TYPE,
	FACE_VALUE
	from
	TB_ENTITY_STOCK 
	where FUNCTION_ROLE_ID = #functionRoleId:varchar#
	and STOCK_STATE = '1'
	and FLD_01_RES_DATA is null
	and DATA_STATE = '1')) t1 on t3.PRODUCT_ID = t1.PRODUCT_ID
   left join 
	(select 
	PRODUCT_ID,
	count(CARD_NO) as stockValue
	from
	TB_ENTITY_STOCK
	where
	ENTITY_ID = #issuerId#
	and
	STOCK_STATE = '1'
	and
    FUNCTION_ROLE_ID = #functionRoleId:varchar#
    and FLD_01_RES_DATA is null
	and DATA_STATE = '1'
	group by PRODUCT_ID) t2 on t3.PRODUCT_ID = t2.PRODUCT_ID
	left join
	(select t1.PRODUCT_ID,t2.DICT_NAME
	from
	TB_PRODUCT t1,
	TB_DICT_INFO t2
	where t1.ONYMOUS_STAT = t2.DICT_CODE
	and DICT_TYPE_CODE = '816'
	group by t1.PRODUCT_ID,t2.DICT_NAME) t4 on t3.PRODUCT_ID = t4.PRODUCT_ID
   left join
	(select t1.PRODUCT_ID,t2.DICT_NAME
	from
	TB_PRODUCT t1,
	TB_DICT_INFO t2
	where t1.PRODUCT_TYPE = t2.DICT_CODE
	and DICT_TYPE_CODE = '815'
	group by t1.PRODUCT_ID,t2.DICT_NAME) t5 on t3.PRODUCT_ID = t5.PRODUCT_ID
    left join 
	(select t1.PRODUCT_ID,t2.DICT_NAME
	from
	TB_ENTITY_STOCK t1,
	TB_DICT_INFO t2
	where t1.FACE_VALUE_TYPE = t2.DICT_CODE
	and DICT_TYPE_CODE = '136'
	and t1.FUNCTION_ROLE_ID = #functionRoleId:varchar#
	group by t1.PRODUCT_ID,t2.DICT_NAME) t6 on t3.PRODUCT_ID = t6.PRODUCT_ID
	where t2.STOCKVALUE > 0  
	</select>
</sqlMap>