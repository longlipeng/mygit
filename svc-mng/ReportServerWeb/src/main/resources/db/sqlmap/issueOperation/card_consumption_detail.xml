<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="card_consumption_detail">
	<select id="card_consumption_detail" resultClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO"
			parameterClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO">
		
		select 
			p.card_no as "priAcctNo",
		    x.mchnt_cd as "mchntCd",
		    x.merchant_name as "merchantName",
		    x.shop_code as "shopCode",
		    x.shop_name as "shopName",
		    x.term_id as "termId",
		    x.primary_key as "primaryKey",
		    q.product_name as "primaryKey2",
		    x.TRANS_NAME as "transName",
		    to_char(x.trans_rcv_ts, 'yyyy-MM-dd') as "transRcvTS",
		    trim(to_char(decode(x.trans_at,null,0,x.trans_at) ,'9999999990.99'))/ 100 as "transAt"
		from	
		(select 
		     m.pri_acct_no,
		     m.mchnt_cd,
		     k.merchant_name,
		     n.shop_code,
		     n.shop_name,
		     m.term_id,
		     m.primary_key,
		     e.TRANS_NAME,
		     m.trans_rcv_ts,
		     m.trans_at
		from
		   tbl_trans_log_his m
        left join
		(select
		    c.shop_code,c.shop_name,d.pos_barcode,c.entity_id
		from
		    tb_shop c,TB_SHOP_POS d
		where
		    c.shop_id = d.shop_id and c.CONSUMER_ID=#IssuerId#) n on m.term_id =n.pos_barcode
        left join
        	tb_trans_type e on m.trans_id = e.trans_code 
        left join
       		tb_merchant k on m.mchnt_cd =k.merchant_code
        and 
			n.entity_id=k.entity_id
		where
		    (m.trans_id ='S22' or m.trans_id ='V52' or m.trans_id ='S10' or m.trans_id ='V40' 
		    or m.trans_id ='S20' or m.trans_id ='V50' or m.trans_id ='S55' or m.trans_id ='S66' or m.trans_id='G30')
		and
		    (m.trans_st !='4' and m.trans_st !='5')
		and 
		     m.resp_cd1 ='00'
		and 
			k.FATHER_ENTITY_ID=#IssuerId#
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&gt;=to_date(#startDate#,'yyyy-MM-dd')
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&lt;=to_date(#endDate#,'yyyy-MM-dd')
	       <isNotEmpty prepend="and" property="merchantNo">
               m.mchnt_cd = #merchantNo#
           </isNotEmpty>
        ) x  left join
        	tb_acc_card_info p
        on
            substr(x.pri_acct_no,3, length(x.pri_acct_no)-2) = p.card_no
        left join
            tb_product q
        on
            p.product_id= q.product_id and q.ENTITY_ID=#IssuerId#
        order by p.card_no, x.trans_rcv_ts asc
	    
	</select>
	
	<select id="card_consumption_detail_today1" resultClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO"
			parameterClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO">
			
		select 
			p.card_no as "priAcctNo",
		    x.mchnt_cd as "mchntCd",
		    x.merchant_name as "merchantName",
		    x.shop_code as "shopCode",
		    x.shop_name as "shopName",
		    x.term_id as "termId",
		    x.primary_key as "primaryKey",
		    q.product_name as "primaryKey2",
		    x.TRANS_NAME as "transName",
		    to_char(x.trans_rcv_ts, 'yyyy-MM-dd') as "transRcvTS",
		    trim(to_char(decode(x.trans_at,null,0,x.trans_at) ,'9999999990.99'))/ 100 as "transAt"
		from
		(select 
		     m.pri_acct_no,
		     m.mchnt_cd,
		     k.merchant_name,
		     n.shop_code,
		     n.shop_name,
		     m.term_id,
		     m.primary_key,
		     e.TRANS_NAME,
		     m.trans_rcv_ts,
		     m.trans_at
		from
		   tbl_trans_log1 m
        left join
		(select
		    c.shop_code,c.shop_name,d.pos_barcode,c.entity_id
		from
		    tb_shop c,tb_shop_pos d
		where
		    c.shop_id = d.shop_id and c.CONSUMER_ID=#IssuerId#) n on m.term_id =n.pos_barcode
        left join
        	tb_trans_type e on m.trans_id = e.trans_code
        left join
        	tb_merchant k on m.mchnt_cd =k.merchant_code
        and 
			n.entity_id=k.entity_id
		where
			(m.trans_id ='S22' or m.trans_id ='V52' or m.trans_id ='S10' or m.trans_id ='V40' 
		    or m.trans_id ='S20' or m.trans_id ='V50' or m.trans_id ='S55' or m.trans_id ='S66' or m.trans_id='G30')
		and
		    (m.trans_st !='4' and m.trans_st !='5')
		and 
		     m.resp_cd1 ='00'
		and 
			k.FATHER_ENTITY_ID=#IssuerId#
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&gt;=to_date(#startDate#,'yyyy-MM-dd')
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&lt;=to_date(#endDate#,'yyyy-MM-dd')
	    	<isNotEmpty prepend="and" property="merchantNo">
                m.mchnt_cd = #merchantNo#
        	</isNotEmpty>
        ) x left join
        	tb_acc_card_info p
        on
            substr(x.pri_acct_no,3, length(x.pri_acct_no)-2) = p.card_no
        left join
            tb_product q
        on
            p.product_id= q.product_id and q.ENTITY_ID=#IssuerId#
        order by p.card_no, x.trans_rcv_ts asc
	  
	</select>
	
	<select id="card_consumption_detail_today2" resultClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO"
			parameterClass="com.allinfinance.service.sellOperation.cardConsumptionDetail.dto.CardConsumptionDetailDTO">
		select 
			p.card_no as "priAcctNo",
		    x.mchnt_cd as "mchntCd",
		    x.merchant_name as "merchantName",
		    x.shop_code as "shopCode",
		    x.shop_name as "shopName",
		    x.term_id as "termId",
		    x.primary_key as "primaryKey",
		    q.product_name as "primaryKey2",
		    x.TRANS_NAME as "transName",
		    to_char(x.trans_rcv_ts, 'yyyy-MM-dd') as "transRcvTS",
		    trim(to_char(decode(x.trans_at,null,0,x.trans_at) ,'9999999990.99'))/ 100 as "transAt"
		from
		(select 
		     m.pri_acct_no,
		     m.mchnt_cd,
		     k.merchant_name,
		     n.shop_code,
		     n.shop_name,
		     m.term_id,
		     m.primary_key,
		     e.TRANS_NAME,
		     m.trans_rcv_ts,
		     m.trans_at
		from
		   tbl_trans_log2 m
        left join
		(select
		    c.shop_code,c.shop_name,d.pos_barcode,c.entity_id
		from
		    tb_shop c,tb_shop_pos d
		where
		    c.shop_id = d.shop_id and c.CONSUMER_ID=#IssuerId#) n on m.term_id =n.pos_barcode
        left join
        	tb_trans_type e on m.trans_id = e.trans_code
        left join
        	tb_merchant k on m.mchnt_cd =k.merchant_code
        and 
			n.entity_id=k.entity_id
		where
			(m.trans_id ='S22' or m.trans_id ='V52' or m.trans_id ='S10' or m.trans_id ='V40' 
		    or m.trans_id ='S20' or m.trans_id ='V50' or m.trans_id ='S55' or m.trans_id ='S66' or m.trans_id='G30')
		and
		    (m.trans_st !='4' and m.trans_st !='5')
		and 
		     m.resp_cd1 ='00'
		and 
			k.FATHER_ENTITY_ID=#IssuerId#
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&gt;=to_date(#startDate#,'yyyy-MM-dd')
		and
		   to_date(to_char(m.trans_rcv_ts, 'yyyyMMdd'),'yyyyMMdd')&lt;=to_date(#endDate#,'yyyy-MM-dd')
	    	<isNotEmpty prepend="and" property="merchantNo">
                m.mchnt_cd = #merchantNo#
        	</isNotEmpty>
        ) x left join
        	tb_acc_card_info p
        on
            substr(x.pri_acct_no,3, length(x.pri_acct_no)-2) = p.card_no
        left join
            tb_product q
        on
            p.product_id= q.product_id and q.ENTITY_ID=#IssuerId#
        order by p.card_no, x.trans_rcv_ts asc
	  
	</select>
</sqlMap>