<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="calculate_with_merchant">
	<select id="calculate_with_merchant" resultClass="com.allinfinance.service.consumer.calculateWithMerchant.dto.CalculateWithMerchantDTO"
		parameterClass="com.allinfinance.service.consumer.calculateWithMerchant.dto.CalculateWithMerchantDTO">

select t1.merchant_code "merchantCode",
       t1.merchant_name "merchantName",
       
       decode(t2.txnTotalCount, null, 0, t2.txnTotalCount) "txnTotalCount",
       trim(to_char(((decode(t3.txnTotalAmt, null, 0, t3.txnTotalAmt) - decode(t4.txnTotalAmt, null, 0, t4.txnTotalAmt)) / 100),'9999999990.99')) "txnTotalAmt",
       (decode(t3.txnTotalAmt, null, 0, t3.txnTotalAmt) - decode(t4.txnTotalAmt, null, 0, t4.txnTotalAmt)) / 100 "txnTotalAmtN",
       
       decode(t5.consumeTotalCount, null, 0, t5.consumeTotalCount) "consumeTotalCount",
       trim(to_char(decode(t5.consumeTotalAmt, null, 0, t5.consumeTotalAmt) / 100,'9999999990.99')) "consumeTotalAmt",
       decode(t5.consumeTotalAmt, null, 0, t5.consumeTotalAmt) / 100 "consumeTotalAmtN",
       
       decode(t6.consumeCancelTotalCount, null, 0, t6.consumeCancelTotalCount) "consumeCancelTotalCount",
       trim(to_char(decode(t6.consumeCancelTotalAmt, null, 0, t6.consumeCancelTotalAmt) / 100,'9999999990.99')) "consumeCancelTotalAmt",
       decode(t6.consumeCancelTotalAmt, null, 0, t6.consumeCancelTotalAmt) / 100 "consumeCancelTotalAmtN",
       
       decode(t7.preAuthCompTotalCount, null, 0, t7.preAuthCompTotalCount) "preAuthCompTotalCount",
       trim(to_char(decode(t7.preAuthCompTotalAmt, null, 0, t7.preAuthCompTotalAmt) / 100,'9999999990.99')) "preAuthCompTotalAmt",
       decode(t7.preAuthCompTotalAmt, null, 0, t7.preAuthCompTotalAmt) / 100 "preAuthCompTotalAmtN",
       
       decode(t8.preAuthCompCancelTotalCount, null, 0, t8.preAuthCompCancelTotalCount) "preAuthCompCancelTotalCount",
       trim(to_char(decode(t8.preAuthCompCancelTotalAmt, null, 0, t8.preAuthCompCancelTotalAmt) / 100,'9999999990.99')) "preAuthCompCancelTotalAmt",
       decode(t8.preAuthCompCancelTotalAmt, null, 0, t8.preAuthCompCancelTotalAmt) / 100 "preAuthCompCancelTotalAmtN",
       
       decode(t9.chargeTotalCount, null, 0, t9.chargeTotalCount) "chargeTotalCount",
       trim(to_char(decode(t9.chargeTotalAmt, null, 0, t9.chargeTotalAmt) / 100,'9999999990.99')) "chargeTotalAmt",
       decode(t9.chargeTotalAmt, null, 0, t9.chargeTotalAmt) / 100 "chargeTotalAmtN",
       
       decode(t10.chargeCancelTotalCount, null, 0, t10.chargeCancelTotalCount) "chargeCancelTotalCount",
       trim(to_char(decode(t10.chargeCancelTotalAmt, null, 0, t10.chargeCancelTotalAmt) / 100,'9999999990.99')) "chargeCancelTotalAmt",
       decode(t10.chargeCancelTotalAmt, null, 0, t10.chargeCancelTotalAmt) / 100 "chargeCancelTotalAmtN",
       
       decode(t11.refundTotalCount, null, 0, t11.refundTotalCount) "refundTotalCount",
       trim(to_char(decode(t11.refundTotalAmt, null, 0, t11.refundTotalAmt) / 100,'9999999990.99')) "refundTotalAmt",       
       decode(t11.refundTotalAmt, null, 0, t11.refundTotalAmt) / 100 "refundTotalAmtN",
       
       decode(t12.creditAdjustmentTotalCount, null, 0, t12.creditAdjustmentTotalCount) "creditAdjustmentTotalCount",
       trim(to_char(decode(t12.creditAdjustmentTotalAmt, null, 0, t12.creditAdjustmentTotalAmt) / 100,'9999999990.99')) "creditAdjustmentTotalAmt",       
       decode(t12.creditAdjustmentTotalAmt, null, 0, t12.creditAdjustmentTotalAmt) / 100 "creditAdjustmentTotalAmtN",
       
       decode(t13.debitAdjustmentTotalCount, null, 0, t13.debitAdjustmentTotalCount) "debitAdjustmentTotalCount",
       trim(to_char(decode(t13.debitAdjustmentTotalAmt, null, 0, t13.debitAdjustmentTotalAmt) / 100,'9999999990.99')) "debitAdjustmentTotalAmt",       
       decode(t13.debitAdjustmentTotalAmt, null, 0, t13.debitAdjustmentTotalAmt) / 100 "debitAdjustmentTotalAmtN"
  from tb_merchant t1
       left join 
       (
       <!-- 交易总笔数 S22:消费；S20:预授权完成；S32:充值；S66:借记调整；S55:贷记调整；S30:退货；V52:消费撤销；V50:预授权完成撤销；V62:充值撤销 -->
       <!-- 交易总笔数 -->
       select t.mchnt_cd, count(t.txn_seq_no) as txnTotalCount
          from tb_settle_trans_pre t
         where t.trans_id in
               ('S22','G22', 'S20', 'S32', 'S66', 'S55', 'S30', 'V52', 'V50', 'V62','G30')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t2 on t1.merchant_code = t2.mchnt_cd
       <!-- 借记类交易总金额 -->  
       left join 
       (select t.mchnt_cd, sum(t.trans_at_sgl) as txnTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id in ('S22','G22', 'S20', 'S66', 'V62')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         and   trim(t.pri_acct_no) !='00'
         group by t.mchnt_cd) t3 on t1.merchant_code = t3.mchnt_cd
        <!-- 贷记类交易总金额 -->
       left join    
       (select t.mchnt_cd, sum(t.trans_at_sgl) as txnTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id in ('S32','G32', 'S30', 'S55', 'V52', 'V50','G30')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t4 on t1.merchant_code = t4.mchnt_cd
       <!-- 消费总笔数、消费总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as consumeTotalCount,
               sum(t.trans_at_sgl) as consumeTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id in ('S22','G22')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         and   trim(t.pri_acct_no) !='00'
         group by t.mchnt_cd) t5 on  t1.merchant_code = t5.mchnt_cd
       <!-- 消费撤销总笔数、消费撤销总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as consumeCancelTotalCount,
               sum(t.trans_at_sgl) as consumeCancelTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'V52'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t6 on  t1.merchant_code = t6.mchnt_cd
       <!-- 预授权完成总笔数、预授权完成总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as preAuthCompTotalCount,
               sum(t.trans_at_sgl) as preAuthCompTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'S20'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t7 on  t1.merchant_code = t7.mchnt_cd
       <!-- 预授权完成撤销总笔数、预授权完成撤销总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as preAuthCompCancelTotalCount,
               sum(t.trans_at_sgl) as preAuthCompCancelTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'V50'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t8 on t1.merchant_code = t8.mchnt_cd
       <!-- 充值总笔数、充值总金额 -->
       left join
       (select t.mchnt_cd,
               count(t.txn_seq_no) as chargeTotalCount,
               sum(t.trans_at_sgl) as chargeTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id in ('S32','G32')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t9 on  t1.merchant_code = t9.mchnt_cd
       <!-- 充值撤销总笔数、充值撤销总金额 -->
       left join
       (select t.mchnt_cd,
               count(t.txn_seq_no) as chargeCancelTotalCount,
               sum(t.trans_at_sgl) as chargeCancelTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'V62'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t10 on  t1.merchant_code = t10.mchnt_cd
       <!-- 退货总笔数、退货总金额 -->
       left join
       (select t.mchnt_cd,
               count(t.txn_seq_no) as refundTotalCount,
               sum(t.trans_at_sgl) as refundTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id in ('S30','G30')
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t11 on t1.merchant_code = t11.mchnt_cd
       <!-- 贷记调整总笔数、贷记调整总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as creditAdjustmentTotalCount,
               sum(t.trans_at_sgl) as creditAdjustmentTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'S55'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t12 on t1.merchant_code = t12.mchnt_cd
       <!-- 借记调整总笔数、借记调整总金额 -->
       left join 
       (select t.mchnt_cd,
               count(t.txn_seq_no) as debitAdjustmentTotalCount,
               sum(t.trans_at_sgl) as debitAdjustmentTotalAmt
          from tb_settle_trans_pre t
         where t.trans_id = 'S66'
         and   to_date(t.settle_dt,'yyyyMMdd') &gt;= to_date(#startDate#,'yyyy-MM-dd')
         and   to_date(t.settle_dt,'yyyyMMdd') &lt;= to_date(#endDate#,'yyyy-MM-dd')
         group by t.mchnt_cd) t13 on t1.merchant_code = t13.mchnt_cd
 where t1.FATHER_ENTITY_ID = #issuerId#
	</select>
</sqlMap>