<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="SUMAMOUNT_ORDER_BATCH">

  <select id="cpConsumeOrderSumDate" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		
		select 
		    distinct(substr(TRADE_TIME,1,8))
		from 
		    cp_consume_order 
		where 
		    type=#txnType:VARCHAR#
		and
		    SUM_BATCH_ID is null
		
   </select>
   
   <!-- 消费订单汇总 -->
   <insert id="insertCpConsumeOrder" parameterClass="com.allinfinance.svc.coupon.dto.InsertOrderBatchDto" >
     insert into TB_SUM_ORDER_RESULT (ID, SUM_BATCH_ID, SERIAL_NO, TRADE_TYPE, TRADE_DATE,
      		CUSTOMER_ENTITY_ID, FATHER_ENTITY_ID, AMOUNT, STATUS, CREATED_TIME, UPDATED_TIME)
        select
           SEQ_SUM_ORDER_RESULT.nextVal,
           #batchNo:BIGINT#,
           replace(char(current_date),'-','') || right(digits(SEQ_SUM_ORDER_RESULT_SERIAL_NO.nextval),8),
           #sumTxnTypeCode:VARCHAR#,
           #tradeDate:VARCHAR#, 
		   MCHT_ENTITY_ID as customerId,
		   FATHER_ENTITY_ID,
		   sum(amount) as sumAmount,
           '0',
           CURRENT timestamp,
           CURRENT timestamp
		from 
		    cp_consume_order
        where
            type=#txnType:VARCHAR#
        and
            SUM_BATCH_ID=#batchNo:BIGINT#
        group by FATHER_ENTITY_ID, MCHT_ENTITY_ID
   </insert>
	  
   <select id="cpDepositOrderDate" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		
		select 
		    distinct(substr(TRADE_TIME,1,8))
		from 
		    cp_deposit_order 
		where 
		    SUM_BATCH_ID is null
		
    </select>

	<!-- 充值订单汇总 -->
    <insert id="insertCpDepositOrder" parameterClass="com.allinfinance.svc.coupon.dto.InsertOrderBatchDto" >
     insert into TB_SUM_ORDER_RESULT (ID, SUM_BATCH_ID, SERIAL_NO, TRADE_TYPE, TRADE_DATE,
      		CUSTOMER_ENTITY_ID, FATHER_ENTITY_ID, AMOUNT, STATUS, CREATED_TIME, UPDATED_TIME)
        select
           SEQ_SUM_ORDER_RESULT.nextVal,
           #batchNo:BIGINT#,
           replace(char(current_date),'-','') || right(digits(SEQ_SUM_ORDER_RESULT_SERIAL_NO.nextval),8),
           #sumTxnTypeCode:VARCHAR#,
           #tradeDate:VARCHAR#, 
		   CUSTOMER_ENTITY_ID as customerId,
		   FATHER_ENTITY_ID,
		   sum(amount) as sumAmount,
           '0',
           CURRENT timestamp,
           CURRENT timestamp
		from 
		    cp_deposit_order
        where
            SUM_BATCH_ID=#batchNo:BIGINT#
        group by FATHER_ENTITY_ID, CUSTOMER_ENTITY_ID
   </insert>
	
	
	
	<select id="cpDepositRefundOrderDate" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		select 
		    distinct(substr(TRADE_TIME,1,8))
		from 
		    cp_deposit_refund_order
		where 
		    SUM_BATCH_ID is null
		
    </select>

	<!-- 充退订单汇总 -->
    <insert id="insertCpDepositRefundOrder" parameterClass="com.allinfinance.svc.coupon.dto.InsertOrderBatchDto" >
        insert into TB_SUM_ORDER_RESULT (ID, SUM_BATCH_ID, SERIAL_NO, TRADE_TYPE, TRADE_DATE,
      		CUSTOMER_ENTITY_ID, FATHER_ENTITY_ID, AMOUNT, STATUS, CREATED_TIME, UPDATED_TIME)
        select
           SEQ_SUM_ORDER_RESULT.nextVal,
           #batchNo:BIGINT#,
           replace(char(current_date),'-','') || right(digits(SEQ_SUM_ORDER_RESULT_SERIAL_NO.nextval),8),
           #sumTxnTypeCode:VARCHAR#,
           #tradeDate:VARCHAR#, 
		   CUSTOMER_ENTITY_ID as customerId,
		   FATHER_ENTITY_ID,
		   sum(amount) as sumAmount,
           '0',
           CURRENT timestamp,
           CURRENT timestamp
		from 
		    cp_deposit_refund_order
        where
            SUM_BATCH_ID=#batchNo:BIGINT#
        group by  FATHER_ENTITY_ID, CUSTOMER_ENTITY_ID
   </insert>
   
   <!-- 记账信息表中最大ID-->
   <select id="nextMaxId" resultClass="java.lang.Long"
		parameterClass="java.lang.String">
		select 
		    max(id)+1
		from 
		    SVC_STL.TBL_SAP_INFO
    </select>
</sqlMap>