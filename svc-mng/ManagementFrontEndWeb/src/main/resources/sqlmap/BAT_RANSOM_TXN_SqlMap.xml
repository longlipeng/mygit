<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RANSOM">
	<insert id="insertRansomActTxn" parameterClass="com.allinfinance.univer.businessbatch.dto.RansomBatchDTO">
		insert into
		tbl_bat_card_state_txn
		(txn_seq,
		txn_type,
		settle_dt,
		txn_amt,
		txn_fee,
		txn_state,
		card_no,
		cancel_flag,
		rec_crt_ts,
		upd_crt_ts,
		callback)
		values
		(#txnSeq:CHAR#,#txnType:CHAR#, #smltDt:CHAR#,
		#txnAmt:CHAR#,#txnFee:CHAR#, #txnState:CHAR#,
		#cardNo:VARCHAR#,
		#cancelFlag:VARCHAR#, #recCrtTs:CHAR#,
		#recUpdTs:CHAR#,
		#callBack:VARCHAR#)
	</insert>
	<select id="getRansomState" resultClass="java.util.HashMap"
		remapResults="true" parameterClass="com.allinfinance.univer.businessbatch.dto.BatchFileDetailDTO">
		<include refid="Commons.prefixSql" />
		select t2.order_id as "orderId",
		t2.batch_no as "batchNo",
		t1.card_no as
		"cardNo",
		t1.txn_amt/100 as "txnAmt",
		t1.resp_code as "respCode"
		from
		tbl_bat_card_state_txn t1,
		tbl_acc_batch_sum t2,
		tbl_acc_batch_detail
		t3
		where t2.batch_no = t3.batch_no
		and t3.txn_seq = t1.txn_seq
		and
		t1.txn_state = '2'
		<isNotNull prepend="and" property="orderId">
			t2.order_id =
			#orderId:VARCHAR#
	   </isNotNull>
		<isNotNull prepend="and" property="batchNO">
			t2.batch_no =
			#batchNO:VARCHAR#
	   </isNotNull>
		<include refid="Commons.suffixSql" />
	</select>

	<select id="getSucAmt" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		select sum(txn_amt) from tbl_acc_batch_detail where
		batch_no = #batchNo:CHAR# 
	</select>

	<update id="cardStateChange" parameterClass="java.lang.String">
	UPDATE TB_ENTITY_STOCK T
	   SET T.STOCK_STATE = DECODE((SELECT CST.CANCEL_STATE
	      FROM TBL_ACC_BATCH_DETAIL   BD,
	           TBL_BAT_CARD_STATE_TXN CST
	     WHERE BD.TXN_SEQ = CST.TXN_SEQ
	       AND T.CARD_NO = CST.CARD_NO
	       AND BD.BATCH_NO = #batchNo:VARCHAR#
	       ), '0' , '1' , '1' , '5' , '5' )
	 WHERE T.CARD_NO IN (SELECT CST.CARD_NO CARD_NO
	       FROM TBL_ACC_BATCH_DETAIL BD, TBL_BAT_CARD_STATE_TXN CST
	      WHERE BD.TXN_SEQ = CST.TXN_SEQ
	        AND BD.BATCH_NO = #batchNo:VARCHAR#)
	</update>
	
	<select id="getCardNos" parameterClass="java.lang.String" resultClass="com.allinfinance.univer.businessbatch.dto.RansomBatchDTO">
		SELECT CST.CARD_NO as "cardNo", decode(cancel_state,'0' , '1' , '1' , '5' , '5') as  "cancelState"
	       FROM TBL_ACC_BATCH_DETAIL BD, TBL_BAT_CARD_STATE_TXN CST
	      WHERE BD.TXN_SEQ = CST.TXN_SEQ
	        AND BD.BATCH_NO = #batchNo:VARCHAR#
	</select>
	<update id="updateCardInfo"  parameterClass="com.huateng.framework.ibatis.model.SellOrderCardList">
		update TB_ACC_CARD_INFO set cardholder_id =#cardholderId:varchar# where card_no=#cardNo:varchar# 
	</update>
	<select id="getBatchRechargeInfo" resultClass="java.util.HashMap" remapResults="true" parameterClass="com.allinfinance.framework.dto.BatchRechargeDTO" >
		<include refid="Commons.prefixSql" />
		select t1.RECHARGE_CARD_NO as "cardNo",CAST((to_number(t1.RECHARGE_AMT)/100)  AS decimal(9,2)) as "rechargeSum",TO_DATE (t1.CREATE_TIME,'YYYY-MM-DD HH24:MI:SS') as "createTime",
		t1.RECHARGE_STATE as "rechargeState",t1.RECHARGE_BATCH_NO as "bacthNo",CAST((to_number(t1.RECHARGE_FEE)/100)  AS decimal(9,2)) as "rechargeFee",t2.USER_NAME  AS "createUser" from 
		TBL_RECHARGE_BATCH_DETAIL t1 LEFT JOIN  TB_ENT_USER t2 ON   t1.create_user=t2.USER_ID
		where 
		 t1.RECHARGE_TYPE='00'
		<isNotEmpty prepend="and" property="cardNo">
			t1.RECHARGE_CARD_NO =
			#cardNo:VARCHAR#
	   </isNotEmpty>
	   <isNotEmpty prepend="and" property="createTime">
			t1.SMLT_DATE =
			#createTime:VARCHAR#
	   </isNotEmpty>
	   order by  t1.CREATE_TIME desc
	   <include refid="Commons.suffixSql" />
	</select>
	
	<insert id="insertActivate" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		insert into
		TBL_ACTIVATE_BATCH
		(
			ACTIVATE_BATCH_NO,
			ACTIVATE_STATE,
			ACTIVATE_NUM,
			CREATE_USER,
			CREATE_TIME,
			FILE_NAME,
			FLAG
		)
		values
		(
			#batchNo:VARCHAR#,
			#activateState:VARCHAR#,
			#cardNum:VARCHAR#,
			#createUser:VARCHAR#,
			#createTime:VARCHAR#,
			#fileName:VARCHAR#,
			#flag:VARCHAR#
		)
	</insert>
	
	<select id="getBatchActivateList" resultClass="java.util.HashMap" remapResults="true" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		<include refid="Commons.prefixSql" />
		select 
			t1.ACTIVATE_BATCH_NO 								   as "batchNo",
			t1.ACTIVATE_NUM 									   as "activateNum",
			TO_DATE (t1.CREATE_TIME,'yyyy-MM-dd HH24miss')	   AS "createTime",
			DECODE(T1.ACTIVATE_STATE,'00','成功','01','处理中','02','失败') as "activateState",
			DECODE(T1.FLAG,'01','首充','02','激活','03','再充值') as "flag",
			t1.FILE_NAME										   AS "fileName",
			t1.FAIL_REASON										   AS "failReason",
			t2.USER_NAME                                           AS "createUser"
			from
			(
		        SELECT
		            ACTIVATE_BATCH_NO ,
		            ACTIVATE_NUM ,
		            CREATE_TIME,
		            ACTIVATE_STATE,
		            FLAG,
		            FILE_NAME ,
		            FAIL_REASON,
					create_user
		        FROM
		            TBL_ACTIVATE_BATCH
		        WHERE
		            ACTIVATE_BATCH_NO IN
		            (
		                SELECT
		                    RECHARGE_BATCH_NO
		                FROM
		                    TBL_RECHARGE_BATCH_DETAIL
		                WHERE 
		                	1=1
		                	<isNotEmpty prepend="and" property="cardNo">
								RECHARGE_CARD_NO like '%'||#cardNo:VARCHAR#||'%' 
					   		</isNotEmpty>
		            ) 
		    ) t1
		    LEFT JOIN
			    TB_ENT_USER t2
			ON
			    t1.create_user=t2.USER_ID
			where 1=1
			<isNotEmpty prepend="and" property="batchNo">
				t1.ACTIVATE_BATCH_NO like '%'||#batchNo:VARCHAR#||'%' 
	   		</isNotEmpty>
	   		<isNotEmpty prepend="and" property="fileName">
				t1.FILE_NAME like '%'||#fileName:VARCHAR#||'%' 
	   		</isNotEmpty>
	   		<isNotEmpty prepend="and" property="beginTime">
	   			subStr(t1.CREATE_TIME,1,8)&gt;=#beginTime:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="endTime">
				subStr(t1.CREATE_TIME,1,8)&lt;=#endTime:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="activateState">
				t1.ACTIVATE_STATE=#activateState:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="flag">
				t1.FLAG=#flag:VARCHAR#
			</isNotEmpty>
			order by  t1.CREATE_TIME desc
			<include refid="Commons.suffixSql" />
	</select>
	
	<select id="getBatchActivateDetail" resultClass="java.util.HashMap" remapResults="true" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		<include refid="Commons.prefixSql" />
		select
			RECHARGE_CARD_NO as "cardNo",
			CAST((to_number(RECHARGE_AMT)/100)  AS decimal(9,2)) as "amt"
		from
			TBL_RECHARGE_BATCH_DETAIL
		where
			RECHARGE_BATCH_NO = #batchNo:VARCHAR#
		order by
			RECHARGE_BATCH_NO
		<include refid="Commons.suffixSql" />
	</select>
	<select id="getBatchActivateCardDetail" resultClass="java.util.HashMap" remapResults="true" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		<include refid="Commons.prefixSql" />
		select
			RECHARGE_CARD_NO as "cardNo"
		from
			TBL_RECHARGE_BATCH_DETAIL
		where
			RECHARGE_BATCH_NO = #batchNo:VARCHAR#
		order by
			RECHARGE_BATCH_NO
		<include refid="Commons.suffixSql" />
	</select>
	
	<insert id="batchInsertRechargeDTO" parameterClass="com.allinfinance.framework.dto.BatchRechargeDTO">
		insert into
		TBL_RECHARGE_BATCH_DETAIL
		(
			RECHARGE_TXN_SEQ_NO,
			SMLT_DATE,
			SMLT_TIME,
			RECHARGE_BATCH_NO,
			RECHARGE_TYPE,
			RECHARGE_CARD_NO,
			RECHARGE_AMT,
			RECHARGE_FEE,
			RECHARGE_STATE,
			CREATE_USER,
			CREATE_TIME
		)
		values
		(
			#rechargeTxnSeqNo:VARCHAR#,
			#smltDate:VARCHAR#,
			#smltTime:VARCHAR#,
			#bacthNo:VARCHAR#,
			#rechargeType:VARCHAR#,
			#cardNo:VARCHAR#,
			#rechargeSum:VARCHAR#,
			#rechargeFee:VARCHAR#,
			#rechargeState:VARHCAR#,
			#createUser:VARHCAR#,
			#createTime:VARCHAR#
		)
	</insert>
	
	<insert id="insertBatch" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		insert into
		TBL_ACTIVATE_BATCH
		(ACTIVATE_BATCH_NO,
		ACTIVATE_NUM,
		CREATE_USER,
		FILE_NAME,
		ACTIVATE_STATE,
		CREATE_TIME)
		values
		(#batchNo:VARCHAR#,
		#cardNum:VARCHAR#,
		#createUser:VARCHAR#,
		#fileName:VARCHAR#,
		#activateState:VARCHAR#,
		#createTime:VARCHAR#
		)
	</insert>
	<insert id="insertDetail" parameterClass="com.allinfinance.framework.dto.BatchActivateDTO">
		insert into
		TBL_ACTIVATE_BATCH_DETAIL
		(ACTIVATE_BATCH_NO,
		ACTIVATE_CARD_NO,
		ACTIVATE_AMT)
		values
		(
			#batchNo:VARCHAR#,
			#cardNo:VARCHAR#,
			#activateAmt:VARCHAR#
		)
	</insert>
</sqlMap>