<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TB_CARD_INFO">

	<!-- 查询卡号账户类型 -->
	<select id="selectCardAccount" resultClass="com.huateng.accorecard.cardinfo.CardAccountDTO"
		parameterClass="com.huateng.accorecard.cardinfo.CardAccountDTO"
		remapResults="true">

		SELECT
			T1.ACCOUNT_NO as "accountNo",
			T1.ACC_TYPE as "accType",
			T1.CARD_NO as "cardNo"
		FROM
			TB_REL_CARD_ACCOUNT T1
		WHERE
			T1.CARD_NO = #cardNo:VARCHAR#
		ORDER BY 
			T1.ACC_TYPE
  </select>
  
	<update id="updateCardAccount" parameterClass="com.huateng.accorecard.cardinfo.CardAccountDTO">
		UPDATE TB_REL_CARD_ACCOUNT T1
		SET T1.ACCOUNT_NO=#accountNo:VARCHAR#
		WHERE
		T1.ACC_TYPE = #accType:DECIMAL#
		AND
		T1.CARD_NO = #cardNo:VARCHAR#
  </update>

	<!-- 查询卡片余额 -->
	<select id="selectCardBalance" resultClass="com.huateng.accorecard.cardinfo.CardAccountDTO"
		parameterClass="com.huateng.accorecard.cardinfo.CardAccountDTO"
		remapResults="true">
		select 
			t1.card_no       as cardNo,
			 t1.valid_date    as validDate,
       		t1.product_id    as productId,
       		t2.account_no    as accountNo,
       		t4.product_name  as productName,
       		t3.acc_type      as accType,
       		t5.acc_type_name as accTypeName,
       		t3.acc_bal       as accBalance
  		from 	
  			tb_card_info        t1,
       		tb_rel_card_account t2,
       		tb_account_info     t3,
       		tb_ent_product      t4,
       		tb_ent_acctype      t5
 		where 
 			t1.card_no = t2.card_no
   		and t2.account_no = t3.account_no
   		and t1.product_id = t4.product_id
   		and t3.acc_type = t5.acc_type_id
   		and t1.card_no = #cardNo:VARCHAR#
	</select>
	
	<!-- 取帐务系统时间 -->
	<select id="getAccountSystemDate" resultClass="java.util.HashMap" >
		select curr_date  as "currDate"
		from tb_bat_ctrl 
	</select>
	
	<!-- 锁定卡号生成流水表 -->
	<select id="lockCardSerialNumber" resultClass="com.huateng.accor.ibatis.model.CardSerialNumber">
		SELECT 	T.CARD_TYPE 	as "cardType",
       			T.ISSUER_ID		as "issuerId",
       			T.ISSUER_CODE	as "issuerCode",
       			T.SUB_ISSUER_CODE as "subIssuerCode",
       			T.SERIAL_NUMBER   as "serialNumber"
  		FROM 	TB_ENT_CARD_SERIAL_NUMBER T
   		FOR UPDATE  with RS 
	</select>
</sqlMap>
