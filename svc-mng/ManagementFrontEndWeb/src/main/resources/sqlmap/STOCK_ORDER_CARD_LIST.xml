<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="STOCK_ORDER_CARD_LIST">
	
	<!-- 查询订单卡明细 -->
	<select id="selectOrderCardListPageData" resultClass="java.util.HashMap" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderCardListQueryDTO" remapResults="true">
		<include refid="Commons.prefixSql" />
	    SELECT
	        ORDER_CARD_LIST_ID as "orderCardListId",
        	ORDER_LIST_ID as "orderListId",
	        CARD_STATE as "cardState",
	        CARDHOLDER_ID      as    "cardholderId",
	        FIRST_NAME as "cardholderName",
	        EXTERNAL_ID as "externalId",
	        LEG_CARD_NO as "legCardNo",
	        CARD_NO as "cardNo" 
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	   	AND
    		DATA_STATE = '1'
		    <dynamic>
		      <isNotEmpty prepend="and" property="cardNo">
		        CARD_NO LIKE '%'||#cardNo:VARCHAR#||'%'
		      </isNotEmpty>
		    </dynamic>
	    <include refid="Commons.suffixSql" />
	</select>
	
	<!-- 查询订单录入卡 -->
	<select id="selectOrderInputCardListPageData" resultClass="java.util.HashMap" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderInputCardListDTO" remapResults="true">
		<include refid="Commons.prefixSql" />
	    SELECT
        	ORDER_ID as "orderId",
	        CARD_NO as "cardNo"  
	    FROM 
	   		TB_CATDNO_TMP
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
		    <dynamic>
		      <isNotEmpty prepend="and" property="cardNo">
		        CARD_NO = #cardNo:VARCHAR#
		      </isNotEmpty>
		    </dynamic>
	    <include refid="Commons.suffixSql" />
	</select>
	
	<select id="selectOrderInputCardListData" resultClass="com.allinfinance.univer.seller.order.dto.SellOrderInputCardListDTO" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderInputCardListDTO" remapResults="true">
	    SELECT
        	ORDER_ID as "orderId",
	        CARD_NO as "cardNo"  
	    FROM 
	   		TB_CATDNO_TMP
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	</select>
	<!-- 采购订单迭代查询订单卡明细 -->
	<select id="selectOrderCardListPageDataIterator" resultClass="java.util.HashMap" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderCardListQueryDTO" remapResults="true">
		<include refid="Commons.prefixSql" />
    	SELECT
    		ORDER_CARD_LIST_ID as "orderCardListId",
        	ORDER_LIST_ID as "orderListId",
	        CARD_STATE as "cardState",
	        CARDHOLDER_ID      as    "cardholderId",
	        FIRST_NAME as "cardholderName",
	        EXTERNAL_ID as "externalId",
	        LEG_CARD_NO as "legCardNo",
	        CARD_NO as "cardNo" 
    	FROM
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID IN
			<isNotEmpty prepend="" property="oldOrderList">
		        <iterate property="oldOrderList"  conjunction="," close=")" open="(" > 
					#oldOrderList[]# 
				</iterate>
			</isNotEmpty>
			<isEmpty prepend="" property="oldOrderList">
				(null)
			</isEmpty>
		AND T.DATA_STATE = '1'
		    <dynamic>
		      <isNotEmpty prepend="and" property="cardNo">
		        CARD_NO = #cardNo:VARCHAR#
		      </isNotEmpty>
		    </dynamic>
	    <include refid="Commons.suffixSql" />
	</select>
	
	<!-- 采购订单迭代查询 订单卡明细 -->
	<select id="selectOrderCardListIterator" resultClass="com.huateng.framework.ibatis.model.SellOrderCardList" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderCardListQueryDTO" remapResults="true">
    	SELECT
    		ORDER_CARD_LIST_ID as "orderCardListId",
       		ORDER_LIST_ID as "orderListId",
	        CARD_STATE as "cardState",
	        CARDHOLDER_ID      as    "cardholderId",
	        <!-- 
	        Modify By Yifeng.Shi @ 2011-05-11
	        Cause there's no method named cardholerName in the class SellOrderCardList
	        -->
	        <!--FIRST_NAME as "cardholderName", -->
	        
	        FIRST_NAME as "firstName",
	        EXTERNAL_ID as "externalId",
	        LEG_CARD_NO as "legCardNo",
	        CARD_NO as "cardNo"
    	FROM 
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID IN
			<isNotEmpty prepend="" property="oldOrderList">
		        <iterate property="oldOrderList"  conjunction="," close=")" open="(" > 
					#oldOrderList[]# 
				</iterate>
			</isNotEmpty>
			<isEmpty prepend="" property="oldOrderList">
				(null)
			</isEmpty>
		AND T.DATA_STATE = '1'
		order by T.Card_No asc
	</select>
	
	<!-- 采购订单迭代查询订单卡明细制卡  未完成数量 -->
	<select id="countBuyOrderUnSuccessCard" resultClass="java.lang.Integer" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderDTO" remapResults="true">
    	SELECT
    		COUNT(*)
    	FROM 
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID IN
			<isNotEmpty prepend="" property="orderIds">
		        <iterate property="orderIds"  conjunction="," close=")" open="(" > 
					#orderIds[]# 
				</iterate>
			</isNotEmpty>
			<isEmpty prepend="" property="orderIds">
				(null)
			</isEmpty>
		AND T.DATA_STATE = '1'
		AND (T.CARD_STATE != '3' AND T.CARD_STATE != '4')
	</select>
	
	<!-- 库存订单卡明细制卡  未完成数量 -->
	<select id="countStockOrderUnSuccessCard" resultClass="java.lang.Integer" 
			parameterClass="java.lang.String" remapResults="true">
    	SELECT
    		COUNT(*)
    	FROM 
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID = #orderId:VARCHAR#
		AND T.DATA_STATE = '1'
		AND (T.CARD_STATE != '3' AND T.CARD_STATE != '4')
	</select>
	
	<!-- 库存订单制卡失败卡数量-->
	<select id="countStockOrderFailCard" resultClass="java.lang.Integer" 
			parameterClass="java.lang.String" remapResults="true">
	    SELECT
	        COUNT(*)
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	   	AND
    		DATA_STATE = '1'
    	AND 
    		CARD_STATE = '4'
	</select>
	
	<!-- 采购订单制卡失败的卡数量 -->
	<select id="countBuyOrderFailCard" resultClass="java.lang.Integer" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderDTO" remapResults="true">
    	SELECT
    		COUNT(*)
    	FROM 
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID IN
			<isNotEmpty prepend="" property="orderIds">
		        <iterate property="orderIds"  conjunction="," close=")" open="(" > 
					#orderIds[]# 
				</iterate>
			</isNotEmpty>
			<isEmpty prepend="" property="orderIds">
				(null)
			</isEmpty>
		AND T.DATA_STATE = '1'
		AND CARD_STATE = '4'
	</select>
	
	
	<!-- 库存订单制卡完成的卡-->
	<select id="selectStockSuccessCardNoList" resultClass="java.lang.String" 
			parameterClass="java.lang.String" remapResults="true">
	    SELECT
	        CARD_NO AS "cardNo"
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	   	AND
    		DATA_STATE = '1'
    	AND 
    		CARD_STATE = '3'
	</select>
	
	<!-- 采购订单制卡完成的卡号 -->
	<select id="selectBuySuccessCardNoList" resultClass="java.lang.String" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderDTO" remapResults="true">
    	SELECT
    		T.CARD_NO AS "cardNo"
    	FROM 
    		TB_SELL_ORDER_CARD_LIST T
		WHERE 
			T.ORDER_ID IN
			<isNotEmpty prepend="" property="orderIds">
		        <iterate property="orderIds"  conjunction="," close=")" open="(" > 
					#orderIds[]# 
				</iterate>
			</isNotEmpty>
			<isEmpty prepend="" property="orderIds">
				(null)
			</isEmpty>
			
		AND T.DATA_STATE = '1'
		AND CARD_STATE = '3'
	</select>
	
	<!-- 查询订单卡明细 卡号-->
	<select id="selectOrderCardNoList" resultClass="java.lang.String" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderCardListQueryDTO" remapResults="true">
	    SELECT
	        CARD_NO AS "cardNo"
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	   	AND
    		DATA_STATE = '1'
	</select>
	 <select id="selectOrigOrderByBuyOrderId" resultClass="java.lang.String" parameterClass="java.lang.String">
	      	with TB_UNION_ORDER_TEMP(OLDORDER, NEWORDER, LEAFNODE) as
			     ( select OLD_ORDER, NEW_ORDER, LEAF_NODE from TB_UNION_ORDER where NEW_ORDER = #orderId:VARCHAR#
			        union all
			        select OLD_ORDER, NEW_ORDER, LEAF_NODE from TB_UNION_ORDER a, TB_UNION_ORDER_TEMP b  where a.OLD_ORDER = b.NEWORDER
			     )
			select OLDORDER as "orderId" from TB_UNION_ORDER_TEMP where LEAFNODE = 1
	 </select>
	 
	<!-- 查询订单卡接收明细 -->
	<select id="selectOrderCardReceiveListPageData" resultClass="java.util.HashMap" 
			parameterClass="com.allinfinance.univer.seller.order.dto.OrderReceiveCardListQueryDTO" remapResults="true">
		<include refid="Commons.prefixSql" />
	    SELECT
	        t2.CARD_NO as "cardNo",
	        t2.PRODUCT_ID as "productId",
	        t3.PRODUCT_NAME as "productName",
	        t2.FACE_VALUE/100 as "faceValue",
	        decode(t2.FACE_VALUE_TYPE,'0','固定','非固定') as "faceValueType"
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST t1 inner join 
	   		TB_ENTITY_STOCK t2 on t1.card_no = t2.card_no inner join
	   		TB_PRODUCT t3 on t2.product_id = t3.product_id
	   	WHERE
	   		t1.ORDER_ID = #orderId:VARCHAR#
	   	AND
    		t1.DATA_STATE = '1'
    	AND
    		t2.STOCK_STATE = '1'
    	AND 
    		t2.DATA_STATE = '1'
	    <include refid="Commons.suffixSql" />
	</select>
	<!-- 根据卡号段库存订单制卡完成的卡-->
	<select id="selectStockSuccessCardNoListBy" resultClass="java.lang.String" 
			parameterClass="com.allinfinance.univer.seller.order.dto.AcceptOrderDTO" remapResults="true">
	    SELECT
	        CARD_NO AS "cardNo"
	    FROM 
	   		TB_SELL_ORDER_CARD_LIST
	   	WHERE
	   		ORDER_ID = #orderId:VARCHAR#
	   	AND
    		DATA_STATE = '1'
    	AND 
    		CARD_STATE = '3'
    	AND CARD_NO &lt;= #endCardNo:VARCHAR#
    	AND CARD_NO &gt;= #startCardNo:VARCHAR#
    	
	</select>
	<!-- 查询已经入库的卡数量-->
	<select id="selectStockSuccessCardNoListAlready" resultClass="java.lang.Integer" 
			parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderDTO" remapResults="true">
	    SELECT
	        count(CARD_NO) 
	    FROM 
	   		TB_ENTITY_STOCK
	   	WHERE
	   		CARD_NO IN
	   		(SELECT CARD_NO FROM TB_SELL_ORDER_CARD_LIST WHERE ORDER_ID=#orderId:VARCHAR#)
	   	AND
    		DATA_STATE = '1'
    	AND ENTITY_ID=#defaultEntityId:varchar#
    	AND FUNCTION_ROLE_ID='3'
	</select>
</sqlMap>
