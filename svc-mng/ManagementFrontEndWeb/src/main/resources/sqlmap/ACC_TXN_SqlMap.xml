<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="CARD_BALANCE_DATAIL">
	<select id="GET_ACC_CARD_DATAIL_HIS" parameterClass="com.allinfinance.univer.report.dto.CardBalanceDatailDTO"
		resultClass="com.allinfinance.univer.report.dto.CardBalanceDatailDTO">
		SELECT * FROM (
			SELECT 
				to_date(T1.DATE_TXN,'yyyyMMddhh24miss') as txnDate,
				T1.CARD_NO as cardNo,
				decode(T1.ACC_TYPE,'',' ',null,' ',T1.ACC_TYPE) as account,
				decode(T1.TXN_TYPE,'',' ',null,' ',T1.TXN_TYPE) as txnType,
				decode(T1.TXN_AMT,'','0',null,'0',T1.TXN_AMT)/100 as txnAmt,
				decode(T1.ACC_BAL,'','0',null,'0',T1.ACC_BAL)/100 as cardTotalBal,
				decode(TXN_TYPE,'1105_1','D','8055','D','1105','D','1115','D','1305','D','1325','D','2065','D','1065','D','2075','D','1075','D','7055','D','0006','D','1335','D','4105','D','1205','D',
				               '0002','C', '0004','C','0005','C','7125','C','7225','C','3105','C','1306','C','2105','C','5205','C',TXN_TYPE)  as DebtOrCredit,
				MCHNT_CD as mchntCd,
				'' as mchntName,
				TERM_ID as termId
			FROM VI_TXN_RECORD_DETAIL T1
			WHERE T1.RESP_CODE ='00'
			AND T1.ISSUER_ID= #issuerId:varchar#
			AND cast(decode(t1.TXN_AMT,null,'0','','0',t1.TXN_AMT) as bigint) >0
			AND T1.TXN_TYPE in('2075','1065','2065','1335','7125','7055','1325','2105','4105','1105','1205','1075','1306','1305','3105','0004','0005','0006','1115',
	                           '7225','1105_1','5205','8055','0002')
	         AND t1.PRODUCT_ID not in (select PRODUCT_ID from TB_PRODUCT_FOR_REPORT where ENTITY_ID= #issuerId:varchar# and PRODUCT_TYPE='0')
			<isNotEmpty prepend="AND" property="startDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&gt;=to_date(#startDate:varchar#,'yyyy-MM-dd')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="endDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&lt;=to_date(#endDate:varchar#,'yyyy-MM-dd')	
			</isNotEmpty>
			union
			SELECT 
				to_date(T1.DATE_TXN,'yyyyMMddhh24miss') as txnDate,
				T1.CARD_NO as cardNo,
				decode(T1.ACC_TYPE,'',' ',null,' ',T1.ACC_TYPE) as account,
				decode(T1.TXN_TYPE,'',' ',null,' ',T1.TXN_TYPE) as txnType,
				decode(T1.TXN_AMT,'','0',null,'0',T1.TXN_AMT)/100 as txnAmt,
				decode(T1.ACC_BAL,null,'0',T1.ACC_BAL)/100 as cardTotalBal,
				decode(TXN_TYPE,'0002','C',TXN_TYPE)  as DebtOrCredit,
				MCHNT_CD as mchntCd,
				'' as mchntName,
				TERM_ID as termId
			FROM VI_TXN_RECORD_DETAIL T1
			WHERE T1.RESP_CODE ='00'
			AND T1.ISSUER_ID= #issuerId:varchar#
			AND cast(decode(t1.TXN_AMT,null,'0','','0',t1.TXN_AMT) as bigint) =0
			AND T1.TXN_TYPE ='0002'
	         AND t1.PRODUCT_ID not in (select PRODUCT_ID from TB_PRODUCT_FOR_REPORT where ENTITY_ID= #issuerId:varchar# and PRODUCT_TYPE='0')
			<isNotEmpty prepend="AND" property="startDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&gt;=to_date(#startDate:varchar#,'yyyy-MM-dd')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="endDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&lt;=to_date(#endDate:varchar#,'yyyy-MM-dd')	
			</isNotEmpty>
			AND T1.CARD_NO in (
				 select  t2.card_no as cardNo from tb_sell_Order  t
	                left join TB_SELL_ORDER_CARD_LIST t2 on t.order_id =t2.order_id
	                 where t.order_type='60000001' and t.ORDER_STATE ='32' and t2.DATA_STATE='1' AND T.PROCESS_ENTITY_ID=  #issuerId:varchar#
	                  AND t.PRODUCT_ID not in (select PRODUCT_ID from TB_PRODUCT_FOR_REPORT where ENTITY_ID=  #issuerId:varchar# and PRODUCT_TYPE='0' )
				)
			)
		ORDER BY txnDate
	</select>
	<select id="GET_CARD_NO_BY_ORDER_TYPE" parameterClass="com.allinfinance.univer.report.dto.CardBalanceDatailDTO"
		resultClass="com.allinfinance.univer.report.dto.CardBalanceDatailDTO">
		
		
		SELECT * FROM (
			 select  t2.card_no as cardNo, t3.card_no as origCardNo ,to_date(t.ORDER_DATE,'yyyyMMdd') as txnDate from tb_sell_Order  t
	                left join TB_SELL_ORDER_CARD_LIST t2 on t.order_id =t2.order_id
	                  left join  TB_SELL_ORDER_ORIGCARD_LIST  t3 on t.order_id =t3.order_id
	                 where t.order_type='60000001' and t.ORDER_STATE ='32' and t2.DATA_STATE='1' AND T.PROCESS_ENTITY_ID=  #issuerId:varchar#
	                  AND t.PRODUCT_ID not in (select PRODUCT_ID from TB_PRODUCT_FOR_REPORT where ENTITY_ID=  #issuerId:varchar# and PRODUCT_TYPE='0' )
			<!-- <isNotEmpty prepend="AND" property="startDate">
				to_date(T.ORDER_DATE,
				'yyyy-MM-dd')&gt;=to_date(#startDate:varchar#,'yyyy-MM-dd')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="endDate">
				to_date(T.ORDER_DATE,
				'yyyy-MM-dd')&lt;=to_date(#endDate:varchar#,'yyyy-MM-dd')	
			</isNotEmpty> -->
			and t2.card_no in(
					SELECT 
				T1.CARD_NO as cardNo
			FROM VI_TXN_RECORD_DETAIL T1
			WHERE T1.RESP_CODE ='00'
			AND T1.ISSUER_ID= #issuerId:varchar#
			AND T1.TXN_TYPE ='0002'
	         AND t1.PRODUCT_ID not in (select PRODUCT_ID from TB_PRODUCT_FOR_REPORT where ENTITY_ID= #issuerId:varchar# and PRODUCT_TYPE='0')
			<isNotEmpty prepend="AND" property="startDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&gt;=to_date(#startDate:varchar#,'yyyy-MM-dd')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="endDate">
				to_date(T1.DATE_SETTLE,
				'yyyy-MM-dd')&lt;=to_date(#endDate:varchar#,'yyyy-MM-dd')	
			</isNotEmpty>
			
			)
			)
		ORDER BY txnDate
	</select>
</sqlMap>