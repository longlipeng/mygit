<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="CHANNEL">
  <select id="selectChannelsByDTO" parameterClass="com.huateng.accor.channel.dto.ChannelQueryDTO" resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
    select
        T1.CHANNEL_ID as "channelId",
        T1.CHANNEL_NAME as "channelName",
        T1.ISSUER_GROUP_ID as "issuerGroupId",
        T2.ISSUER_GROUP_NAME as "issuerGroupName",
        T1.ISSUER_ID as "issuerId",
        T3.ISSUER_NAME as "issuerName"
    from
        TB_ENT_CHANNEL T1,
        TB_ENT_ISSUER_GROUP T2,
        TB_ENT_ISSUER T3
    where
        T1.ISSUER_GROUP_ID = T2.ISSUER_GROUP_ID
        and T1.ISSUER_ID = T3.ISSUER_ID(+)
        and T1.DATA_STATE = '1'
    <dynamic>
      <isNotNull prepend="and" property="channelId">
        T1.CHANNEL_ID = #channelId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="and" property="channelName">
        T1.CHANNEL_NAME like '%'||#channelName:VARCHAR#||'%'
      </isNotNull>
      <isNotNull prepend="and" property="issuerGroupId">
        T1.ISSUER_GROUP_ID = #issuerGroupId:DECIMAL#
      </isNotNull>
      <isNotNull prepend="and" property="issuerId">
        T1.ISSUER_ID = #issuerId:DECIMAL#
      </isNotNull>
      <isNull prepend="and" property="issuerId">
        <isNotEqual property="defaultIssuerId" compareValue="0">
          T1.ISSUER_ID = #defaultIssuerId:DECIMAL#
        </isNotEqual>
      </isNull>
    </dynamic>
    <include refid="Commons.suffixSql"/>
  </select>

  <select id="countChannelUsedById" parameterClass="java.lang.Integer" resultClass="java.lang.Integer">
    select
        NVL(T2.count + T3.count, 0) as count
    from
        TB_ENT_CHANNEL T1,
        (
            select
                count(*) as count,
                CHANNEL_ID
            from
                TB_ENT_CUSTOMER T4
            where T4.DATA_STATE = '1'
            group by CHANNEL_ID
        ) T2,
        (
            select
                count(*) as count,
                CHANNEL_ID
            from
                TB_ENT_MERCHANT T5
            where T5.DATA_STATE = '1'
            group by CHANNEL_ID
        ) T3
    where
        T1.CHANNEL_ID = #channelId:DECIMAL#
        and T1.CHANNEL_ID = T2.CHANNEL_ID(+)
        and T1.CHANNEL_ID = T3.CHANNEL_ID(+)
        and (T2.count > 0 or T3.count > 0)
  </select>
</sqlMap>