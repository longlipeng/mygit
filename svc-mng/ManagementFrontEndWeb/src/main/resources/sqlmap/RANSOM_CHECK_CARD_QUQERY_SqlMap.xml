<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RANSOM_CHECK_CARD_QUQERY">
  <select id="ransomCheckCard" parameterClass="com.allinfinance.univer.seller.order.dto.SellOrderOrigCardListDTO" 
  	resultClass="java.util.HashMap" remapResults="true">
    <include refid="Commons.prefixSql"/>
	 select 
	   T.CARD_NO as "cardNo",
	   T.PRODUCT_ID as "productId",
	   T.VALID_DATE as "validityPeriodStr",
	   to_date(T.VALID_DATE,'yyyy-MM-dd') as "validityPeriod",
	   T.CARD_STAT as "cardSate",
	   T.LOCK_STAT as "lockState",
	   T.LOST_STAT as "lostState",
	   T.CANCEL_STAT as "cancelSate",
	   T.amount as "amountStr",
	   decode(T.amount,null,0,T.amount)/100  as "amount",
	   T.CARDHOLDER_ID as "cardholderId"
    from
	(select 
	   a.CARD_NO,
	   a.PRODUCT_ID,
	   a.VALID_DATE,
	   a.CARD_STAT,
	   a.LOCK_STAT,
	   a.LOST_STAT,
	   a.CANCEL_STAT,
       a.CARDHOLDER_ID,
	   sum(c.ACC_BAL-c.FREESE_AMT) as amount
	from 
 TB_ACC_CARD_INFO a right join  TB_ACC_REL_CARD_ACCOUNT b on a.CARD_NO = b.CARD_NO
right join TB_ACC_ACCOUNT_INFO c on b.ACCOUNT_NO =c.ACCOUNT_NO   right join tb_cardholder d on a.CARDHOLDER_ID=d.CARDHOLDER_ID
where a.CARD_NO = #cardNo:VARCHAR# and d.ENTITY_ID=#firstEntityId:VARCHAR#
	group by a.CARD_NO,
	   a.PRODUCT_ID,
	   a.VALID_DATE,
	   a.CARD_STAT,
	   a.LOCK_STAT,
	   a.LOST_STAT,
	   a.CANCEL_STAT,
       a.CARDHOLDER_ID) T
UNION all

select 
	   T1.CARD_NO as "cardNo",
	   T1.PRODUCT_ID as "productId",
	   T1.VALID_DATE as "validityPeriodStr",
	   to_date(T1.VALID_DATE,'yyyy-MM-dd') as "validityPeriod",
	   T1.CARD_STAT as "cardSate",
	   T1.LOCK_STAT as "lockState",
	   T1.LOST_STAT as "lostState",
	   T1.CANCEL_STAT as "cancelSate",
	   T1.amount as "amountStr",
	   decode(T1.amount,null,0,T1.amount)/100  as "amount",
	   T1.CARDHOLDER_ID as "cardholderId"
    from
	(select 
	   a.CARD_NO,
	   a.PRODUCT_ID,
	   a.VALID_DATE,
	   a.CARD_STAT,
	   a.LOCK_STAT,
	   a.LOST_STAT,
	   a.CANCEL_STAT,
       a.CARDHOLDER_ID,
	   sum(c.ACC_BAL-c.FREESE_AMT) as amount
	from 
 TB_ACC_CARD_INFO a right join  TB_ACC_REL_CARD_ACCOUNT b on a.CARD_NO = b.CARD_NO
right join TB_ACC_ACCOUNT_INFO c on b.ACCOUNT_NO =c.ACCOUNT_NO   right join TB_COMPANY_INFO d on a.CARDHOLDER_ID=d.RELATION_NO
where a.CARD_NO = #cardNo:VARCHAR#
	group by a.CARD_NO,
	   a.PRODUCT_ID,
	   a.VALID_DATE,
	   a.CARD_STAT,
	   a.LOCK_STAT,
	   a.LOST_STAT,
	   a.CANCEL_STAT,
       a.CARDHOLDER_ID) T1

    <include refid="Commons.suffixSql"/>
  </select>
</sqlMap>