<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="VIRTUALCARD">

	<!-- 获取卡bin来制卡 -->
	<select id="getProductCardBinForLock" parameterClass="java.lang.String"
		resultClass="com.huateng.framework.ibatis.model.ProductCardBin">
		select
		PRODUCT_ID as productId,
		CARD_BIN as cardBin,
		EFFECT
		as effect,
		SERIAL_NUMBER as serialNumber
		from TB_PRODUCT_CARD_BIN
		where
		PRODUCT_ID=#productId#
		for update with rs
	</select>

	<!-- 获取初始状态卡的数量 -->
	<select id="countInitCard" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		select count(*) from CP_VIRTUAL_CARD where
		status=#cardState# and product_id=#productId#
	</select>
	
	<!-- 获取初始状态的卡 -->
	<select id="queryInitCard" parameterClass="java.util.HashMap"
		resultClass="com.suning.svc.ibatis.model.VirtualCard">
		<![CDATA[
		select 
		id as id,
		batch_id as batchId,
		product_id as productId,
		card_no as cardNo,
		available_balance as availableBalance,
		status as status,
		created_time as createdTime,
		updated_time as updatedTime
		 from CP_VIRTUAL_CARD 
		where status=#cardState# and product_id=#productId#
		 fetch first 1000 row only
		 ]]>
	</select>

	<!-- 24小时且状态为内存中的卡数量 -->
	<select id="countCardCanBeUsed" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
	<![CDATA[
		select count(*) from CP_VIRTUAL_CARD c
		where status=#cardState# and product_id=#productId#
		 and #compareTime#>updated_time
		]]>
	</select>
	
	<!-- 获取前多少张卡 -->
	<select id="queryCardCanNoUsed" parameterClass="java.util.HashMap"
		resultClass="com.suning.svc.ibatis.model.VirtualCard">
		<![CDATA[
		select 
		id as id,
		batch_id as batchId,
		product_id as productId,
		card_no as cardNo,
		available_balance as availableBalance,
		status as status,
		created_time as createdTime,
		updated_time as updatedTime
		 from CP_VIRTUAL_CARD 
		where status=#cardState# and product_id=#productId#
		 and updated_time<#compareTime# fetch first 1000 row only
		 ]]>
	</select>

	<select id="queryVirtualCardByPage" resultClass="java.util.HashMap"
		remapResults="true" parameterClass="com.allinfinance.svc.coupon.dto.VirtualCardQueryDto">
		<include refid="Commons.prefixSql" />
		select c.id as "id",
		c.batch_id as "batchId",
		p.product_name as
		"productName",
		c.card_no as "cardNo",
		c.coupon_no as "couponNo",
		c.available_balance as
		"availableBalance",
		c.status as "status",
		c.created_time as
		"createdTime",
		c.updated_time as "updatedTime"
		from cp_virtual_card c
		left join tb_product p on c.product_id=p.product_id
		where 1=1
		<isNotEmpty prepend="and" property="cardNo">
			c.card_no=#cardNo#
		</isNotEmpty>
		<isNotEmpty prepend="and" property="couponNo">
			c.coupon_no=#couponNo#
		</isNotEmpty>
		<isNotEmpty prepend="and" property="status">
			c.status=#status#
		</isNotEmpty>
		<include refid="Commons.suffixSql" />
	</select>
	<!-- 插入卡 -->
	<insert id="virtual_batch_insert" parameterClass="com.suning.svc.ibatis.model.VirtualCard">
		insert into
		CP_VIRTUAL_CARD (ID,CARD_NO)
		values (#id#,#cardNo#)
  </insert>


</sqlMap>